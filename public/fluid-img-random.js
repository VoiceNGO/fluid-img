"use strict";(()=>{var L=class extends Image{#t;constructor(t={}){super(),this.crossOrigin="Anonymous",this.#t=!!t.rotate}get width(){let t=this.#t?super.height:super.width;return t-t%2}get height(){return this.#t?super.width:super.height}},x=class{#t;#e;#r;#n;#i;constructor(t,e){this.#t=t,this.#n=e.rotate,this.#i=e.i,this.#e=this.#a(),this.#r=this.#e.then(r=>this.#s(r))}#a(){return new Promise((t,e)=>{let r=this.#t,n=new L({rotate:this.#n});n.onload=()=>t(n),n.onerror=()=>e(`Failed to load image: ${r}`),n.onabort=()=>e(`Image loading aborted: ${r}`),n.src=r})}#s(t){let e=this.#i;return new Promise(r=>{e?.start("loadImageData");let a=new OffscreenCanvas(t.width,t.height).getContext("2d");this.#n&&(a.translate(t.width,0),a.rotate(Math.PI/2)),a.drawImage(t,0,0);let s=a.getImageData(0,0,t.width,t.height);e?.end("loadImageData"),r(s)})}get src(){return this.#t}get F(){return this.#e}get t(){return this.#r}};var b="fluid-img";var V=p=>t=>{let e=p^t;return e^=e>>>16,e*=2246822507,e^=e>>>13,e*=3266489909,e^=e>>>16,e&1};function v(p,t,e=1){let r=p.length-t.length*e,n=p.constructor,a=new n(r),s=0,i=0,m=-1;for(let o of t){if(m===o)throw new Error("[deleteArrayIndices]: Duplicate index detected");if(m>o)throw new Error("[deleteArrayIndices]: Indices are not sorted");let h=o-i;h>0&&(a.set(p.subarray(i,o),s),s+=h),i=o+e,m=o}return i<p.length&&a.set(p.subarray(i),s),a}function S(p,t,e=!1){let{data:r,width:n,height:a}=p,s=t?new Array(a):new Uint8Array(n*a);for(let i=0;i<a;i++){let m=i*n,o=t?s[i]=new Uint8Array(n):s;for(let h=0;h<n;h++){let c=(m+h)*4,l=r[c],g=r[c+1],u=r[c+2],d=r[c+3],y;e?y=(l+g+u)/3*d/255:y=(.299*l+.587*g+.114*u)*d/255,o[t?h:m+h]=y}}return s}var G=class{#t;#e;#r;#n;#i;#a;constructor(t){this.#e=t.t.width,this.#r=t.t.height,this.#t=new Array(this.#r),this.#i=new Array(this.#r),this.#a=t.it,this.#n=S(t.t,!0),this.#h(),this.#t=this.#o()}#s(t,e){if(!this.#a)return 255;let r=this.#i[t][e];return this.#a[r]}#h(){for(let t=0;t<this.#r;t++){this.#i[t]=new Uint32Array(this.#e);for(let e=0;e<this.#e;e++)this.#i[t][e]=t*this.#e+e}}#o(t=this.#e,e=this.#r){let r=new Array(e);for(let n=0;n<e;n++){r[n]=new Uint16Array(t);let a=Math.max(0,n-1),s=Math.min(e-1,n+1),i=this.#n[a],m=this.#n[n],o=this.#n[s];for(let h=0;h<t;h++){let c=Math.max(0,h-1),l=Math.min(t-1,h+1),g=-i[c]+i[l]+-m[c]*2+m[l]*2+-o[c]+o[l],u=-i[c]+-i[h]*2+-i[l]+o[c]+o[h]*2+o[l],d=(g<0?-g:g)+(u<0?-u:u),y=this.#s(n,h);r[n][h]=d*(y/255)}}return r}get width(){return this.#e}get height(){return this.#r}get r(){return this.#t}get p(){return this.#i}w(t){for(let r=0;r<this.#r;r++){let n=t[r];this.#t[r]=v(this.#t[r],[n]),this.#i[r]=v(this.#i[r],[n])}this.#e--;let e=(r,n)=>r<n?r:r+1;for(let r=0;r<this.#r;r++){let n=t[r],a=Math.max(0,r-1),s=Math.min(this.#r-1,r+1),i=this.#n[a],m=this.#n[r],o=this.#n[s],h=[];n>0&&h.push(n-1),n<this.#e&&h.push(n);for(let c of h){let l=Math.max(0,e(c-1,n)),g=Math.min(this.#n[0].length-1,e(c+1,n)),u=e(c,n),d=-i[l]+i[g]+-m[l]*2+m[g]*2+-o[l]+o[g],y=-i[l]+-i[u]*2+-i[g]+o[l]+o[u]*2+o[g],A=(d<0?-d:d)+(y<0?-y:y),f=this.#s(r,c);this.#t[r][c]=A+f}}}c(t){if(t.length===0)return;let e=t.length;for(let r=0;r<this.#r;r++){let n=t.map(a=>a[r]).sort((a,s)=>a-s);this.#t[r]=v(this.#t[r],n),this.#n[r]=v(this.#n[r],n),this.#i[r]=v(this.#i[r],n)}this.#e-=e,this.#t=this.#o()}u(t=this.#e,e=this.#r){let r=this.#o(t,e),n=1/0,a=0;for(let o=0;o<e;o++)for(let h=0;h<t;h++){let c=r[o][h];c<n&&(n=c),c>a&&(a=c)}let s=a-n,i=new ImageData(t,e),m=i.data;for(let o=0;o<e;o++)for(let h=0;h<t;h++){let c=(o*t+h)*4,l=r[o][h],g=s>0?Math.round((l-n)/s*255):0;m[c]=g,m[c+1]=g,m[c+2]=g,m[c+3]=255}return i}};j("sobel",G);var q=new Map;function j(p,t){Promise.resolve().then(()=>{q.set(p,t)})}function Y(p){let t=p.algorithm??"sobel",e=q.get(t);if(!e)throw new Error(`[${b}] Energy map algorithm '${t}' is not registered or included in the build.`);return new e(p)}var T=class{o;constructor(t){this.o=Y(t)}get width(){return this.o.width}get height(){return this.o.height}get r(){return this.o.r}get p(){return this.o.p}w(t){return this.o.w(t)}c(t){return this.o.c(t)}u(t,e){return this.o.u(t,e)}};var I=class{a;h;S;l=new Uint16Array;f=0;constructor(t){this.a=t.a,this.h=t.h,this.S=this.at()}getImageData(){return this.a.t}G(){return this.a.F}async at(){let t=await this.a.t,e=await this.st();return this.l=new Uint16Array(t.width*t.height).fill(65535),new T({t,it:e})}async st(){if(!this.h)return;let t=await this.h.t;return S(t,!1)}async ot(t){let{width:e}=await this.a.F;if(e<t){debugger;throw new Error(`Cannot generate ${t} seams for image with width ${e}`)}for(;this.f<t;)await this.j();return this.l}};var nt={b:.05,T:10},_=class extends I{connections=[];options;constructor(t){super(t),this.options={...nt,...t}}ht(t){this.options.b=t}async j(){let t=await this.S,e=t.p,r=t.width,n=t.height;this.ct(r,n);let a=Array.from({length:r},(o,h)=>this.mt(t,h));a.sort((o,h)=>o.n-h.n);let s=Math.max(Math.ceil(r*this.options.b)>>1<<1,Math.min(this.options.T,r)),i=a.slice(0,s),m=this.f;for(let o=0;o<i.length;o++)i[o].q.forEach((c,l)=>{let g=e[l][c];if(this.l[g]!==65535)throw new Error("Seam overlap detected");this.l[g]=m}),m++;t.c(i.map(o=>o.q)),this.f+=i.length}ct(t,e){let r=V(t*e+1);this.connections=Array.from({length:e},()=>new Int8Array(t));let n=t-1;for(let a=0;a<e;a++)for(let s=0;s<t;s++)s===n||r(a*t+s)?this.connections[a][s]=0:(this.connections[a][s]=1,this.connections[a][s+1]=-1,s++)}mt(t,e){let r=t.height,n=new Uint16Array(r),a=t.r,s=0,i=e;for(let m=0;m<r;m++)n[m]=i=i+this.connections[m][i],s+=a[m][i];return{q:n,n:s}}};X("random",_);var K=new Map;function X(p,t){Promise.resolve().then(()=>{K.set(p,t)})}function Z(p){let t=p.generator??"random",e=K.get(t);if(!e)throw new Error(`[${b}] Generator '${t}' is not registered or included in the build.`);return new e(p)}var C=class{#t;#e=new Map;#r=[];constructor(t){this.#t=t}start(t,e=0){this.#e.set(t,{startTime:performance.now(),dt:e,K:0}),this.#r.push(t)}end(t){let{startTime:e,dt:r,K:n}=this.#e.get(t),a=performance.now()-e;if(a<r)return;let s=this.#r.length;if(s>1){let i=this.#r[s-2],m=this.#e.get(i);m.K+=a}n>0?this.#t(`${t}: ${(a-n).toFixed(2)}ms (${a.toFixed(2)}ms)`):this.#t(`${t}: ${(a-n).toFixed(2)}ms`),this.#r.pop(),this.#e.delete(t)}};function z(p){return function(...e){if(!this.C)try{let r=p.apply(this,e);return r&&typeof r.catch=="function"?r.catch(n=>{this.U(n)}):r}catch(r){this.U(r)}}}function w(p){return p.replace(/([A-Z])/g,"-$1").toLowerCase()}var J=p=>({yt:(n,a,s=0,i=1)=>{let m=String(n),o=Number(p[w(m)]??a);if(o<s||o>i)throw new Error(`[${b}] \`${m}\` must be between ${s} and ${i}.`);return o},ft:(n,a)=>{let s=String(n),i=p[w(s)];return i===null?!1:i!==void 0?!0:a},bt:(n,a,s)=>{let i=String(n),m=p[w(i)];return m==null?s:Object.values(a).includes(m)?m:(console.warn(`[${b}] Invalid value for ${i}: "${m}". Defaulting to "${s}".`),s)}});var D={Z:"horizontal",Mt:"vertical",_t:"auto",zt:"dual"};var U=class{canvas;J;height=0;width=0;options;k;B;g;D;N=!1;i;C=!1;parentNode;src;mask;M=null;O=z(this.vt).bind(this);Et=z(this.xt).bind(this);constructor(t){let{parentNode:e,src:r,mask:n,...a}=t;this.parentNode=e,this.src=r,this.mask=n;try{this.options=this.Q(a),this.i=new C(this.options.$),this.wt(e)}catch(s){this.U(s)}}destroy(){this.canvas.remove()}get tt(){if(!this.k){let t=new x(this.src,{rotate:!1,i:this.i}),e=this.mask?new x(this.mask,{rotate:!1}):void 0;this.k=this.et({a:t,h:e})}return this.k}get At(){if(!this.B){let t=new x(this.src,{rotate:!0,i:this.i}),e=this.mask?new x(this.mask,{rotate:!0}):void 0;this.B=this.et({a:t,h:e})}return this.B}It(){return this.D?this.At:this.tt}et(t){let e={...this.options,a:t.a,h:t.h};return Z(e)}Q(t){let{ft:e,yt:r,bt:n}=J(t);return{...t,carvingPriority:r("carvingPriority",1),maxCarveUpSeamPercentage:r("maxCarveUpSeamPercentage",.6),maxCarveUpScale:r("maxCarveUpScale",10,1,10),maxCarveDownScale:r("maxCarveDownScale",1),scalingAxis:n("scalingAxis",D,D.Z),$:t.$??(()=>{}),showEnergyMap:e("showEnergyMap",!1),Wt:e("demoMode",!1)}}L(t){let{width:e,height:r}=this.options;if(e===void 0||r===void 0){let n=t.getBoundingClientRect();e=e??n.width,r=r??n.height}return{width:e,height:r}}wt(t){let{width:e,height:r}=this.L(t);this.canvas=document.createElement("canvas"),this.J=this.canvas.getContext("2d"),this.canvas.width=this.width=e,this.canvas.height=this.height=r,this.canvas.style.display="block",t.appendChild(this.canvas),this.v()}get Ft(){return this.g.G().then(t=>t.width)}get Ht(){return this.g.G().then(t=>t.height)}Dt(t,e){this.width=t,this.height=e,this.v()}Vt(t){this.width=t,this.v()}jt(t){this.height=t,this.v()}vt(t){let e=this.options.showEnergyMap;this.options=this.Q({...this.options,...t}),this.options.showEnergyMap!==e&&(this.M=null),this.v()}v(){this.N||(this.N=!0,Promise.resolve().then(async()=>{await this.Et(),this.N=!1}))}Ot(t){let{carvingPriority:e,maxCarveUpSeamPercentage:r,maxCarveUpScale:n,maxCarveDownScale:a}=this.options,{width:s,height:i}=t,{D:m,width:o,height:h}=this,c=m?h:o,l=m?o:h,g=c/l,u=Math.round(i*g),d=s-u;if(d===0)return{_:0,z:0,W:!1};let y=Math.abs(d)*e,A=d>0?a:r,f=s*A,F=d>0?1:-1,E=d>0,M=Math.floor(Math.min(y,f))*F;if(E)return{_:M,z:0,W:E};{let O=Math.round(i/l*c)-s,P=Math.floor(s*n)-s,N=Math.max(0,Math.min(O,P));return{_:-M,z:N,W:E}}}async Pt(){if(this.options.scalingAxis===D.Z)return!1;if(this.options.scalingAxis===D.Mt)return!0;let{width:t,height:e}=await this.tt.G(),r=t/e;return this.width/this.height>r}async Rt(){this.D=await this.Pt(),this.g=this.It()}async St(){if(this.M)return this.M;let t=await this.g.getImageData(),e=new T({t});return this.M=e.u(),this.M}async Gt(){return this.options.showEnergyMap?await this.St():await this.g.getImageData()}async xt(){if(!this.width||!this.height)return;this.i.start("redraw"),await this.Rt();let t=await this.Gt(),{_:e,z:r,W:n}=this.Ot(t),a;if(e===0)a=t;else{this.i.start("generateSeamGrid",1);let h=await this.g.ot(Math.abs(e));this.i.end("generateSeamGrid"),n?a=this.Tt(t,h,e):a=this.Ct(t,h,e,r)}this.canvas.width=a.width,this.canvas.height=a.height,this.J.putImageData(a,0,0);let s=this.canvas.style,{D:i,width:m,height:o}=this;s.transformOrigin="0 0",s.transform=i?"rotate(-90deg) translateX(-100%)":"",s.width=`${i?o:m}px`,s.height=`${i?m:o}px`,this.i.end("redraw")}Ct(t,e,r,n){let{width:a,height:s,data:i}=t,m=a+n,o=m*s*4,h=new Uint8ClampedArray(o),c=0,l=i.length/4,g=Math.floor(n/r),u=n%r,d=0;for(let y=0;y<l;y++){let A=e[y],f=y*4;if(A<r){let E=u>0&&A*u%r<u?g+1:g;if(d===0)for(let M=0;M<E;M++)h[c]=i[f],h[c+1]=i[f+1],h[c+2]=i[f+2],h[c+3]=i[f+3],c+=4;else{let M=(y-1)*4,k=i[M],O=i[M+1],B=i[M+2],P=i[M+3],H=i[f]-k,N=i[f+1]-O,Q=i[f+2]-B,tt=i[f+3]-P,et=E+1;for(let $=0;$<E;$++){let R=($+1)/et;h[c]=Math.round(k+H*R),h[c+1]=Math.round(O+N*R),h[c+2]=Math.round(B+Q*R),h[c+3]=Math.round(P+tt*R),c+=4}}}h[c]=i[f],h[c+1]=i[f+1],h[c+2]=i[f+2],h[c+3]=i[f+3],c+=4,++d===a&&(d=0)}return c!==o&&console.error(`[${b}] Mismatch during interpolation. Wrote ${c} bytes but expected ${o}.`),new ImageData(h,m,s)}Tt(t,e,r){let{width:n,height:a,data:s}=t,i=n-r,m=i*a*4,o=new Uint8ClampedArray(m),h=s.length/4,c=0;for(let l=0;l<h;l++)if(e[l]>=r){let u=l*4;o[c]=s[u],o[c+1]=s[u+1],o[c+2]=s[u+2],o[c+3]=s[u+3],c+=4}return c!==m&&console.error(`[${b}] Mismatch in pixel buffer size. Expected ${m}, but got ${c}.`),new ImageData(o,i,a)}U(t){if(this.C)return;this.C=!0;debugger;console.error(`[${b}] A critical error occurred. Falling back to <img>.`,t),this.canvas?.remove();let e=document.createElement("img");e.src=this.src,e.style.width="100%",e.style.height="100%",e.style.display="block",this.parentNode.appendChild(e)}};var W=class p extends HTMLElement{e=null;P=null;E=null;R=new Set;isIntersecting=!1;x=null;options={};static Ut=new Set(["src","scaling-axis","mask","generator"]);constructor(){super()}static get observedAttributes(){return["src","mask","on-screen-threshold",...["generator","carvingPriority","maxCarveUpSeamPercentage","maxCarveUpScale","maxCarveDownScale","scalingAxis","showEnergyMap","mask"].map(w)]}connectedCallback(){this.kt(),this.rt()}disconnectedCallback(){this.e?.destroy(),this.e=null,this.P?.disconnect(),this.P=null,this.E?.disconnect(),this.E=null}attributeChangedCallback(t,e,r){e!==r&&(this.R.size||setTimeout(this.Bt),this.R.add(t))}Bt=()=>{let t=Array.from(this.R);if(this.R.clear(),t.some(r=>p.Ut.has(r))){this.e?.destroy(),this.e=null,this.Nt();return}if(t.includes("on-screen-threshold")&&this.rt(),!this.e)return;let e=t.reduce((r,n)=>{if(n!=="src"&&n!=="on-screen-threshold"){let a=this.getAttribute(n);r[n]=a}return r},{});this.e.O(e)};$t=t=>{let e=new CustomEvent("log",{detail:{message:t},bubbles:!0,composed:!0});this.dispatchEvent(e)};Nt(){if(this.e)return;let t=this.Lt();this.e=new U({parentNode:this,$:this.$t,...t})}L(){let t=this.clientWidth??100,e=this.clientHeight??100;return{width:t,height:e}}Lt(){let t={};for(let e of p.observedAttributes){let r=w(e);if(this.hasAttribute(r)){let n=this.getAttribute(r);t[e]={"":!0,true:!0,false:!1}[n+""]??n}}return t}kt(){this.parentElement&&(this.P=new ResizeObserver(()=>{let t=this.L();this.x=t,this.nt()}),this.P.observe(this))}rt(){this.E?.disconnect();let t=this.getAttribute("on-screen-threshold")||"50px";this.E=new IntersectionObserver(e=>{for(let r of e)this.isIntersecting=r.isIntersecting,this.isIntersecting&&this.nt()},{rootMargin:`${t} ${t} ${t} ${t}`}),this.E.observe(this)}nt(){!this.isIntersecting||!this.x||(this.e?.Dt(this.x.width,this.x.height),this.x=null)}get maxCarveUpScale(){return this.options["max-carve-up-scale"]}set maxCarveUpScale(t){this.options["max-carve-up-scale"]=t,this.e?.O({maxCarveUpScale:t})}get scalingAxis(){return this.options["scaling-axis"]}set scalingAxis(t){this.options["scaling-axis"]=t,this.e?.O({scalingAxis:t})}get showEnergyMap(){return this.options["show-energy-map"]}set showEnergyMap(t){this.options["show-energy-map"]=t,this.e?.O({showEnergyMap:t})}get onScreenThreshold(){let t=this.getAttribute("on-screen-threshold")||"50px";return parseInt(t.replace("px",""),10)}};customElements.define("fluid-img",W);})();
//# sourceMappingURL=fluid-img-random.js.map
