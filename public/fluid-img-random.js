"use strict";(()=>{var $=class extends Image{#r;constructor(e={}){super(),this.crossOrigin="Anonymous",this.#r=!!e.rotate}get width(){let e=this.#r?super.height:super.width;return e-e%2}get height(){return this.#r?super.width:super.height}},I=class{#r;#e;#t;#n;#a;constructor(e,t){this.#r=e,this.#n=t.rotate,this.#a=t.profiler,this.#e=this.#i(),this.#t=this.#e.then(r=>this.#s(r))}#i(){return new Promise((e,t)=>{let r=this.#r,i=new $({rotate:this.#n});i.onload=()=>e(i),i.onerror=()=>t(`Failed to load image: ${r}`),i.onabort=()=>t(`Image loading aborted: ${r}`),i.src=r})}#s(e){let t=this.#a;return new Promise(r=>{t?.start("loadImageData");let n=new OffscreenCanvas(e.width,e.height).getContext("2d");this.#n&&(n.translate(e.width,0),n.rotate(Math.PI/2)),n.drawImage(e,0,0);let s=n.getImageData(0,0,e.width,e.height);t?.end("loadImageData"),r(s)})}get src(){return this.#r}get image(){return this.#e}get imageData(){return this.#t}};var X=l=>e=>{let t=l^e;return t^=t>>>16,t*=2246822507,t^=t>>>13,t*=3266489909,t^=t>>>16,t&1};function p(l,e,t=1){let r=l.length-e.length*t,i=l.constructor,n=new i(r),s=0,a=0,h=-1;for(let o of e){if(h===o)throw new Error("[deleteArrayIndices]: Duplicate index detected");if(h>o)throw new Error("[deleteArrayIndices]: Indices are not sorted");let c=o-a;c>0&&(n.set(l.subarray(a,o),s),s+=c),a=o+t,h=o}return a<l.length&&n.set(l.subarray(a),s),n}function P(l,e,t=!1){let{data:r,width:i,height:n}=l,s=e?new Array(n):new Uint8Array(i*n);for(let a=0;a<n;a++){let h=a*i,o=e?s[a]=new Uint8Array(i):s;for(let c=0;c<i;c++){let m=(h+c)*4,g=r[m],d=r[m+1],u=r[m+2],f=r[m+3],y;t?y=(g+d+u)/3*f/255:y=(.299*g+.587*d+.114*u)*f/255,o[e?c:h+c]=y}}return s}var O=class{#r;#e;#t;#n;#a;#i;constructor(e,t){this.#e=e.width,this.#t=e.height,this.#r=new Array(this.#t),this.#a=new Array(this.#t),this.#i=t,this.#n=P(e,!0),this.#h(),this.#r=this.#o()}#s(e,t){if(!this.#i)return 255;let r=this.#a[e][t];return this.#i[r]}#h(){for(let e=0;e<this.#t;e++){this.#a[e]=new Uint32Array(this.#e);for(let t=0;t<this.#e;t++)this.#a[e][t]=e*this.#e+t}}#o(e=this.#e,t=this.#t){let r=new Array(t);for(let i=0;i<t;i++){r[i]=new Uint16Array(e);let n=Math.max(0,i-1),s=Math.min(t-1,i+1),a=this.#n[n],h=this.#n[i],o=this.#n[s];for(let c=0;c<e;c++){let m=Math.max(0,c-1),g=Math.min(e-1,c+1),d=-a[m]+a[g]+-h[m]*2+h[g]*2+-o[m]+o[g],u=-a[m]+-a[c]*2+-a[g]+o[m]+o[c]*2+o[g],f=(d<0?-d:d)+(u<0?-u:u),y=this.#s(i,c);r[i][c]=f*(y/255)}}return r}get width(){return this.#e}get height(){return this.#t}get energyMap(){return this.#r}get originalIndices(){return this.#a}removeSeam(e){for(let r=0;r<this.#t;r++){let i=e[r];this.#r[r]=p(this.#r[r],[i]),this.#a[r]=p(this.#a[r],[i])}this.#e--;let t=(r,i)=>r<i?r:r+1;for(let r=0;r<this.#t;r++){let i=e[r],n=Math.max(0,r-1),s=Math.min(this.#t-1,r+1),a=this.#n[n],h=this.#n[r],o=this.#n[s],c=[];i>0&&c.push(i-1),i<this.#e&&c.push(i);for(let m of c){let g=Math.max(0,t(m-1,i)),d=Math.min(this.#n[0].length-1,t(m+1,i)),u=t(m,i),f=-a[g]+a[d]+-h[g]*2+h[d]*2+-o[g]+o[d],y=-a[g]+-a[u]*2+-a[d]+o[g]+o[u]*2+o[d],M=(f<0?-f:f)+(y<0?-y:y),b=this.#s(r,m);this.#r[r][m]=M+b}}}removeSeams(e){if(e.length===0)return;let t=e.length;for(let r=0;r<this.#t;r++){let i=e.map(n=>n[r]).sort((n,s)=>n-s);this.#r[r]=p(this.#r[r],i),this.#n[r]=p(this.#n[r],i),this.#a[r]=p(this.#a[r],i)}this.#e-=t,this.#r=this.#o()}getEnergyMapAsImageData(e=this.#e,t=this.#t){let r=this.#o(e,t),i=1/0,n=0;for(let o=0;o<t;o++)for(let c=0;c<e;c++){let m=r[o][c];m<i&&(i=m),m>n&&(n=m)}let s=n-i,a=new ImageData(e,t),h=a.data;for(let o=0;o<t;o++)for(let c=0;c<e;c++){let m=(o*e+c)*4,g=r[o][c],d=s>0?Math.round((g-i)/s*255):0;h[m]=d,h[m+1]=d,h[m+2]=d,h[m+3]=255}return a}};function F(l,e,t){return(e*t+l)*4}function oe(l,e,t,r){if(l<0||l>=t||e<0||e>=Math.floor(r.length/(t*4)))return 0;let i=F(l,e,t);return .299*r[i]+.587*r[i+1]+.114*r[i+2]*r[i+3]/255}function R(l,e,t,r,i,n){if(l<0||l>=i||e<0||e>=Math.floor(n.length/(i*4))||t<0||t>=i||r<0||r>=Math.floor(n.length/(i*4)))return 0;let s=F(l,e,i),a=F(t,r,i),h=n[s]-n[a],o=n[s+1]-n[a+1],c=n[s+2]-n[a+2];return Math.sqrt(h*h+o*o+c*c)}var T=class{#r;#e;#t;#n;#a;#i;#s;constructor(e,t=1,r){this.#e=e.width,this.#t=e.height,this.#i=e,this.#s=t,this.#r=new Array(this.#t),this.#n=new Array(this.#t),this.#a=new Array(this.#t),this.#h(),this.#o(e),this.#r=this.#c()}#h(){for(let e=0;e<this.#t;e++){this.#a[e]=new Uint32Array(this.#e);for(let t=0;t<this.#e;t++)this.#a[e][t]=e*this.#e+t}}#o(e){for(let t=0;t<this.#t;t++){this.#n[t]=new Uint8Array(this.#e);for(let r=0;r<this.#e;r++)this.#n[t][r]=oe(r,t,this.#e,e.data)}}#m(e,t){let r=Math.max(0,t-1),i=Math.min(this.#t-1,t+1),n=Math.max(0,e-1),s=Math.min(this.#e-1,e+1),a=this.#n[r],h=this.#n[t],o=this.#n[i],c=-a[n]+a[s]+-h[n]*2+h[s]*2+-o[n]+o[s],m=-a[n]+-a[e]*2+-a[s]+o[n]+o[e]*2+o[s];return(c<0?-c:c)+(m<0?-m:m)}#l(e,t){let r=this.#i.data,i=e-1,n=e+1,s=R(i,t,n,t,this.#e,r),a=t-1,h=t+1,o=R(e,a,e,h,this.#e,r),c=0;return i>=0&&a>=0&&(c+=R(i,a,n,t,this.#e,r)),n<this.#e&&h<this.#t&&(c+=R(n,h,i,t,this.#e,r)),s+o+c*.5}#c(e=this.#e,t=this.#t){let r=new Array(t);for(let i=0;i<t;i++){r[i]=new Uint16Array(e);for(let n=0;n<e;n++){let s=this.#m(n,i),a=this.#l(n,i),h=s+this.#s*a;r[i][n]=Math.min(65535,Math.max(0,Math.round(h)))}}return r}get width(){return this.#e}get height(){return this.#t}get energyMap(){return this.#r}get originalIndices(){return this.#a}removeSeam(e){for(let n=0;n<this.#t;n++){let s=e[n];this.#r[n]=p(this.#r[n],[s]),this.#a[n]=p(this.#a[n],[s])}this.#e--;let t=new ImageData(this.#e,this.#t),r=0;for(let n=0;n<this.#t;n++){let s=e[n];for(let a=0;a<this.#e+1;a++)if(a!==s){let h=(n*(this.#e+1)+a)*4;t.data[r]=this.#i.data[h],t.data[r+1]=this.#i.data[h+1],t.data[r+2]=this.#i.data[h+2],t.data[r+3]=this.#i.data[h+3],r+=4}}this.#i=t;let i=(n,s)=>n<s?n:n+1;for(let n=0;n<this.#t;n++){let s=e[n],a=[];s>0&&a.push(s-1),s<this.#e&&a.push(s);for(let h of a){let o=this.#m(h,n),c=this.#l(h,n),m=o+this.#s*c;this.#r[n][h]=Math.min(65535,Math.max(0,Math.round(m)))}}}removeSeams(e){if(e.length===0)return;let t=e.length;for(let n=0;n<this.#t;n++){let s=e.map(a=>a[n]).sort((a,h)=>a-h);this.#r[n]=p(this.#r[n],s),this.#n[n]=p(this.#n[n],s),this.#a[n]=p(this.#a[n],s)}this.#e-=t;let r=new ImageData(this.#e,this.#t),i=0;for(let n=0;n<this.#t;n++){let s=e.map(h=>h[n]).sort((h,o)=>h-o),a=0;for(let h=0;h<this.#e+t;h++){if(a<s.length&&h===s[a]){a++;continue}let o=(n*(this.#e+t)+h)*4;r.data[i]=this.#i.data[o],r.data[i+1]=this.#i.data[o+1],r.data[i+2]=this.#i.data[o+2],r.data[i+3]=this.#i.data[o+3],i+=4}}this.#i=r,this.#r=this.#c()}getEnergyMapAsImageData(e=this.#e,t=this.#t){let r=this.#c(e,t),i=1/0,n=0;for(let o=0;o<t;o++)for(let c=0;c<e;c++){let m=r[o][c];m<i&&(i=m),m>n&&(n=m)}let s=n-i,a=new ImageData(e,t),h=a.data;for(let o=0;o<t;o++)for(let c=0;c<e;c++){let m=(o*e+c)*4,g=r[o][c],d=s>0?Math.round((g-i)/s*255):0;h[m]=d,h[m+1]=d,h[m+2]=d,h[m+3]=255}return a}};function W(l,e,t){return(e*t+l)*4}function K(l,e,t,r){if(l<0||l>=t||e<0||e>=Math.floor(r.length/(t*4)))return 0;let i=W(l,e,t);return .299*r[i]+.587*r[i+1]+.114*r[i+2]*r[i+3]/255}function Y(l,e,t,r,i,n){if(l<0||l>=i||e<0||e>=Math.floor(n.length/(i*4))||t<0||t>=i||r<0||r>=Math.floor(n.length/(i*4)))return 0;let s=W(l,e,i),a=W(t,r,i),h=n[s]-n[a],o=n[s+1]-n[a+1],c=n[s+2]-n[a+2];return Math.sqrt(h*h+o*o+c*c)}function G(l,e,t,r,i){let n=0,s=0,a=0;for(let c=-t;c<=t;c++)for(let m=-t;m<=t;m++){let g=l+m,d=e+c;if(g>=0&&g<r&&d>=0&&d<Math.floor(i.length/(r*4))){let u=K(g,d,r,i);n+=u,s+=u*u,a++}}if(a<2)return 0;let h=n/a,o=s/a-h*h;return Math.sqrt(o)}var C=class{#r;#e;#t;#n;#a;#i;#s;#h;#o;constructor(e,t=5,r=10,i=20,n){this.#e=e.width,this.#t=e.height,this.#i=e,this.#s=t,this.#h=r,this.#o=i,this.#r=new Array(this.#t),this.#n=new Array(this.#t),this.#a=new Array(this.#t),this.#m(),this.#l(e),this.#r=this.#d()}#m(){for(let e=0;e<this.#t;e++){this.#a[e]=new Uint32Array(this.#e);for(let t=0;t<this.#e;t++)this.#a[e][t]=e*this.#e+t}}#l(e){for(let t=0;t<this.#t;t++){this.#n[t]=new Uint8Array(this.#e);for(let r=0;r<this.#e;r++)this.#n[t][r]=K(r,t,this.#e,e.data)}}#c(e,t){let r=Math.max(0,t-1),i=Math.min(this.#t-1,t+1),n=Math.max(0,e-1),s=Math.min(this.#e-1,e+1),a=this.#n[r],h=this.#n[t],o=this.#n[i],c=-a[n]+a[s]+-h[n]*2+h[s]*2+-o[n]+o[s],m=-a[n]+-a[e]*2+-a[s]+o[n]+o[e]*2+o[s];return(c<0?-c:c)+(m<0?-m:m)}#g(e,t){let r=this.#i.data,i=e-1,n=e+1,s=Y(i,t,n,t,this.#e,r),a=t-1,h=t+1,o=Y(e,a,e,h,this.#e,r);return s+o}#u(e,t){let r=this.#i.data,i=this.#c(e,t);if(i<this.#o*.3)return 0;let n=G(e-3,t,2,this.#e,r),s=G(e+3,t,2,this.#e,r),a=G(e,t-3,2,this.#e,r),h=G(e,t+3,2,this.#e,r),o=0,c=Math.min(n,s,a,h);if(c<this.#h*.5){let u=Math.max(0,(this.#h*.5-c)/(this.#h*.5));o=Math.max(o,u*.3)}let m=Math.abs(n-s),g=Math.abs(a-h),d=Math.max(m,g);if(d>this.#h*4&&i>this.#o){let u=Math.min(1,d/(this.#h*8));o=Math.max(o,u*.2)}if(i>this.#o*2.5){let u=Math.min(1,i/(this.#o*4));o=Math.max(o,u*.15)}if(o>0){let u=Math.min(1,i/(this.#o*2));return o*u*200}return 0}#d(e=this.#e,t=this.#t){let r=new Array(t);for(let i=0;i<t;i++){r[i]=new Uint16Array(e);for(let n=0;n<e;n++){let s=this.#c(n,i),a=this.#g(n,i),h=this.#u(n,i),o=s+a+this.#s*h;r[i][n]=Math.min(65535,Math.max(0,Math.round(o)))}}return r}get width(){return this.#e}get height(){return this.#t}get energyMap(){return this.#r}get originalIndices(){return this.#a}removeSeam(e){for(let i=0;i<this.#t;i++){let n=e[i];this.#r[i]=p(this.#r[i],[n]),this.#a[i]=p(this.#a[i],[n])}this.#e--;let t=new ImageData(this.#e,this.#t),r=0;for(let i=0;i<this.#t;i++){let n=e[i];for(let s=0;s<this.#e+1;s++)if(s!==n){let a=(i*(this.#e+1)+s)*4;t.data[r]=this.#i.data[a],t.data[r+1]=this.#i.data[a+1],t.data[r+2]=this.#i.data[a+2],t.data[r+3]=this.#i.data[a+3],r+=4}}this.#i=t;for(let i=0;i<this.#t;i++){let n=e[i],s=[];n>0&&s.push(n-1),n<this.#e&&s.push(n);for(let a of s){let h=this.#c(a,i),o=this.#g(a,i),c=this.#u(a,i),m=h+o+this.#s*c;this.#r[i][a]=Math.min(65535,Math.max(0,Math.round(m)))}}}removeSeams(e){if(e.length===0)return;let t=e.length;for(let n=0;n<this.#t;n++){let s=e.map(a=>a[n]).sort((a,h)=>a-h);this.#r[n]=p(this.#r[n],s),this.#n[n]=p(this.#n[n],s),this.#a[n]=p(this.#a[n],s)}this.#e-=t;let r=new ImageData(this.#e,this.#t),i=0;for(let n=0;n<this.#t;n++){let s=e.map(h=>h[n]).sort((h,o)=>h-o),a=0;for(let h=0;h<this.#e+t;h++){if(a<s.length&&h===s[a]){a++;continue}let o=(n*(this.#e+t)+h)*4;r.data[i]=this.#i.data[o],r.data[i+1]=this.#i.data[o+1],r.data[i+2]=this.#i.data[o+2],r.data[i+3]=this.#i.data[o+3],i+=4}}this.#i=r,this.#r=this.#d()}getEnergyMapAsImageData(e=this.#e,t=this.#t){let r=this.#d(e,t),i=1/0,n=0;for(let o=0;o<t;o++)for(let c=0;c<e;c++){let m=r[o][c];m<i&&(i=m),m>n&&(n=m)}let s=n-i,a=new ImageData(e,t),h=a.data;for(let o=0;o<t;o++)for(let c=0;c<e;c++){let m=(o*e+c)*4,g=r[o][c],d=s>0?Math.round((g-i)/s*255):0;h[m]=d,h[m+1]=d,h[m+2]=d,h[m+3]=255}return a}};var he="sobel",U={dual:{forwardEnergyWeight:1},"boundary-aware":{boundaryPenaltyWeight:5,uniformityThreshold:10,edgeThreshold:20},sobel:{}};function ce(l,e,t){switch(l){case"sobel":return new O(e,t);case"dual":return new T(e,U.dual.forwardEnergyWeight,t);case"boundary-aware":return new C(e,U["boundary-aware"].boundaryPenaltyWeight,U["boundary-aware"].uniformityThreshold,U["boundary-aware"].edgeThreshold,t);default:let r=l;throw new Error(`Unknown energy map algorithm: ${l}`)}}var k=class{impl;constructor(e,t){this.impl=ce(he,e,t)}get width(){return this.impl.width}get height(){return this.impl.height}get energyMap(){return this.impl.energyMap}get originalIndices(){return this.impl.originalIndices}removeSeam(e){return this.impl.removeSeam(e)}removeSeams(e){return this.impl.removeSeams(e)}getEnergyMapAsImageData(e,t){return this.impl.getEnergyMapAsImageData(e,t)}};var A=class{imageLoader;maskLoader;energyMapPromise;seamGrid=new Uint16Array;generatedSeams=0;constructor(e){this.imageLoader=e.imageLoader,this.maskLoader=e.maskLoader,this.energyMapPromise=this.createEnergyMap()}async createEnergyMap(){let e=await this.imageLoader.imageData,t=await this.getMaskData();return this.seamGrid=new Uint16Array(e.width*e.height).fill(65535),new k(e,t)}async getMaskData(){if(!this.maskLoader)return;let e=await this.maskLoader.imageData;return P(e,!1)}async generateSeamGrid(e){let{width:t}=await this.imageLoader.image;if(t<e)throw new Error(`Cannot generate ${e} seams for image with width ${t}`);for(;this.generatedSeams<e;)await this.generateSeamBatch();return this.seamGrid}};var me={batchPercentage:.05,minBatchSize:10},L=class extends A{connections=[];options;constructor(e){super(e),this.options={...me,...e}}setBatchPercentage(e){this.options.batchPercentage=e}async generateSeamBatch(){let e=await this.energyMapPromise,t=e.originalIndices,r=e.width,i=e.height;this.generateConnections(r,i);let n=Array.from({length:r},(o,c)=>this.getSeam(e,c));n.sort((o,c)=>o.energy-c.energy);let s=Math.max(Math.ceil(r*this.options.batchPercentage)>>1<<1,Math.min(this.options.minBatchSize,r)),a=n.slice(0,s),h=this.generatedSeams;for(let o=0;o<a.length;o++)a[o].seam.forEach((m,g)=>{let d=t[g][m];if(this.seamGrid[d]!==65535)throw new Error("Seam overlap detected");this.seamGrid[d]=h}),h++;e.removeSeams(a.map(o=>o.seam)),this.generatedSeams+=a.length}generateConnections(e,t){let r=X(e*t+1);this.connections=Array.from({length:t},()=>new Int8Array(e));let i=e-1;for(let n=0;n<t;n++)for(let s=0;s<e;s++)s===i||r(n*e+s)?this.connections[n][s]=0:(this.connections[n][s]=1,this.connections[n][s+1]=-1,s++)}getSeam(e,t){let r=e.height,i=new Uint16Array(r),n=e.energyMap,s=0,a=t;for(let h=0;h<r;h++)i[h]=a=a+this.connections[h][a],s+=n[h][a];return{seam:i,energy:s}}};function Z(l,e){return!e||e==="random"?new L(l):null}function J(l){let e=Z(l,l.generator)||Z(l);if(!e)throw new Error("[Fluid-Img] No generators are available.");return e}var z=class{#r;#e=new Map;#t=[];constructor(e){this.#r=e}start(e,t=0){this.#e.set(e,{startTime:performance.now(),minLoggingTime:t,totalNestedTime:0}),this.#t.push(e)}end(e){let{startTime:t,minLoggingTime:r,totalNestedTime:i}=this.#e.get(e),n=performance.now()-t;if(n<r)return;let s=this.#t.length;if(s>1){let a=this.#t[s-2],h=this.#e.get(a);h.totalNestedTime+=n}i>0?this.#r(`${e}: ${(n-i).toFixed(2)}ms (${n.toFixed(2)}ms)`):this.#r(`${e}: ${(n-i).toFixed(2)}ms`),this.#t.pop(),this.#e.delete(e)}};function q(l){return function(...t){if(!this.hasFailed)try{let r=l.apply(this,t);return r&&typeof r.catch=="function"?r.catch(i=>{this.handleFailure(i)}):r}catch(r){this.handleFailure(r)}}}function w(l){return l.replace(/([A-Z])/g,"-$1").toLowerCase()}var x="Fluid-Img";var ee=l=>({getConstrainedNumber:(i,n,s=0,a=1)=>{let h=String(i),o=Number(l[w(h)]??n);if(o<s||o>a)throw new Error(`[${x}] \`${h}\` must be between ${s} and ${a}.`);return o},getBoolean:(i,n)=>{let s=String(i),a=l[w(s)];return a===null?!1:a!==void 0?!0:n},getEnumValue:(i,n,s)=>{let a=String(i),h=l[w(a)];return h==null?s:Object.values(n).includes(h)?h:(console.warn(`[${x}] Invalid value for ${a}: "${h}". Defaulting to "${s}".`),s)}});var H={Horizontal:"horizontal",Vertical:"vertical",Auto:"auto",Dual:"dual"};var B=class{canvas;ctx;height=0;width=0;imageLoader;maskLoader;options;generator;redrawQueued=!1;profiler;hasFailed=!1;parentNode;src;mask;cachedEnergyMapImageData=null;setOptions=q(this._setOptions).bind(this);redraw=q(this._redraw).bind(this);constructor(e){let{parentNode:t,src:r,mask:i,...n}=e;this.parentNode=t,this.src=r,this.mask=i;try{this.options=this.validateAndApplyDefaults(n);let s=this.options.scalingAxis==="vertical";this.profiler=new z(this.options.logger),this.imageLoader=new I(r,{rotate:s,profiler:this.profiler}),this.mask&&(this.maskLoader=new I(this.mask,{rotate:s})),this.generator=this.createGenerator(),this.initializeCanvas(t)}catch(s){this.handleFailure(s)}}destroy(){this.canvas.remove()}createGenerator(){let e={...this.options,imageLoader:this.imageLoader,maskLoader:this.maskLoader};return J(e)}validateAndApplyDefaults(e){let{getBoolean:t,getConstrainedNumber:r,getEnumValue:i}=ee(e);return{...e,carvingPriority:r("carvingPriority",1),maxCarveUpSeamPercentage:r("maxCarveUpSeamPercentage",.6),maxCarveUpScale:r("maxCarveUpScale",10,1,10),maxCarveDownScale:r("maxCarveDownScale",1),scalingAxis:i("scalingAxis",H,H.Horizontal),logger:e.logger??(()=>{}),showEnergyMap:t("showEnergyMap",!1),demoMode:t("demoMode",!1)}}calculateDimensions(e){let{width:t,height:r}=this.options;if(t===void 0||r===void 0){let i=e.getBoundingClientRect();t=t??i.width,r=r??i.height}return{width:t,height:r}}initializeCanvas(e){let{width:t,height:r}=this.calculateDimensions(e);this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.canvas.width=this.width=t,this.canvas.height=this.height=r,this.canvas.style.display="block",e.appendChild(this.canvas),this.queueRedraw()}setSize(e,t){this.width=e,this.height=t,this.queueRedraw()}setWidth(e){this.width=e,this.queueRedraw()}setHeight(e){this.height=e,this.queueRedraw()}_setOptions(e){let t=this.options.showEnergyMap;this.options=this.validateAndApplyDefaults({...this.options,...e}),this.options.showEnergyMap!==t&&(this.cachedEnergyMapImageData=null),this.queueRedraw()}queueRedraw(){this.redrawQueued||(this.redrawQueued=!0,Promise.resolve().then(async()=>{await this.redraw(),this.redrawQueued=!1}))}determineCarvingParameters(e){let{carvingPriority:t,maxCarveUpSeamPercentage:r,maxCarveUpScale:i,maxCarveDownScale:n}=this.options,{width:s,height:a}=e,h=this.width/this.height,o=Math.round(a*h),c=s-o;if(c===0)return{availableSeams:0,interpolationPixels:0,carveDown:!1};let m=Math.abs(c)*t,g=c>0?n:r,d=s*g,u=c>0?1:-1,f=c>0,y=Math.floor(Math.min(m,d))*u;if(f)return{availableSeams:y,interpolationPixels:0,carveDown:f};{let b=Math.round(a/this.height*this.width)-s,E=Math.floor(s*i)-s,D=Math.max(0,Math.min(b,E));return{availableSeams:-y,interpolationPixels:D,carveDown:f}}}async getEnergyMapImageData(){if(this.cachedEnergyMapImageData)return this.cachedEnergyMapImageData;let e=await this.imageLoader.imageData,t=new k(e);return this.cachedEnergyMapImageData=t.getEnergyMapAsImageData(),this.cachedEnergyMapImageData}async getSourceImageData(){return this.options.showEnergyMap?await this.getEnergyMapImageData():await this.imageLoader.imageData}async _redraw(){if(!this.width||!this.height)return;this.profiler.start("redraw");let e=await this.getSourceImageData(),{availableSeams:t,interpolationPixels:r,carveDown:i}=this.determineCarvingParameters(e),n;if(t===0)n=e;else{this.profiler.start("generateSeamGrid",1);let h=await this.generator.generateSeamGrid(t);this.profiler.end("generateSeamGrid"),i?n=this.filterPixels(e,h,t):n=this.interpolatePixels(e,h,t,r)}this.canvas.width=n.width,this.canvas.height=n.height,this.ctx.putImageData(n,0,0);let s=this.canvas.style,a=this.options.scalingAxis==="vertical";s.transformOrigin="0 0",s.transform=a?"rotate(-90deg) translateX(-100%)":"",s.width=`${a?this.height:this.width}px`,s.height=`${a?this.width:this.height}px`,this.profiler.end("redraw")}interpolatePixels(e,t,r,i){let{width:n,height:s,data:a}=e,h=n+i,o=h*s*4,c=new Uint8ClampedArray(o),m=0,g=a.length/4,d=Math.floor(i/r),u=i%r,f=0;for(let y=0;y<g;y++){let M=t[y],b=y*4;if(M<r){let E=u>0&&M*u%r<u?d+1:d;if(f===0)for(let v=0;v<E;v++)c[m]=a[b],c[m+1]=a[b+1],c[m+2]=a[b+2],c[m+3]=a[b+3],m+=4;else{let v=(y-1)*4,D=a[v],_=a[v+1],j=a[v+2],Q=a[v+3],re=a[b]-D,ne=a[b+1]-_,ie=a[b+2]-j,ae=a[b+3]-Q,se=E+1;for(let N=0;N<E;N++){let S=(N+1)/se;c[m]=Math.round(D+re*S),c[m+1]=Math.round(_+ne*S),c[m+2]=Math.round(j+ie*S),c[m+3]=Math.round(Q+ae*S),m+=4}}}c[m]=a[b],c[m+1]=a[b+1],c[m+2]=a[b+2],c[m+3]=a[b+3],m+=4,++f===n&&(f=0)}return m!==o&&console.error(`[${x}] Mismatch during interpolation. Wrote ${m} bytes but expected ${o}.`),new ImageData(c,h,s)}filterPixels(e,t,r){let{width:i,height:n,data:s}=e,a=i-r,h=a*n*4,o=new Uint8ClampedArray(h),c=s.length/4,m=0;for(let g=0;g<c;g++)if(t[g]>=r){let u=g*4;o[m]=s[u],o[m+1]=s[u+1],o[m+2]=s[u+2],o[m+3]=s[u+3],m+=4}return m!==h&&console.error(`[${x}] Mismatch in pixel buffer size. Expected ${h}, but got ${m}.`),new ImageData(o,a,n)}handleFailure(e){if(this.hasFailed)return;this.hasFailed=!0,console.error(`[${x}] A critical error occurred. Falling back to <img>.`,e),this.canvas?.remove();let t=document.createElement("img");t.src=this.src,t.style.width="100%",t.style.height="100%",t.style.display="block",this.parentNode.appendChild(t)}};var V=class l extends HTMLElement{renderer=null;resizeObserver=null;intersectionObserver=null;updateQueue=new Set;isIntersecting=!1;storedDimensions=null;options={};constructor(){super()}static get observedAttributes(){return["src","mask","on-screen-threshold",...["generator","carvingPriority","maxCarveUpSeamPercentage","maxCarveUpScale","maxCarveDownScale","scalingAxis","showEnergyMap","mask"].map(w)]}connectedCallback(){this.setupResizeObserver(),this.setupIntersectionObserver()}disconnectedCallback(){this.renderer?.destroy(),this.renderer=null,this.resizeObserver?.disconnect(),this.resizeObserver=null,this.intersectionObserver?.disconnect(),this.intersectionObserver=null}attributeChangedCallback(e,t,r){t!==r&&(this.updateQueue.size||setTimeout(this.processUpdates),this.updateQueue.add(e))}processUpdates=()=>{let e=Array.from(this.updateQueue);if(this.updateQueue.clear(),e.includes("src")||e.includes("scaling-axis")||e.includes("mask")){this.renderer?.destroy(),this.renderer=null,this.initializeRenderer();return}if(e.includes("on-screen-threshold")&&this.setupIntersectionObserver(),!this.renderer)return;let t=e.reduce((r,i)=>{if(i!=="src"&&i!=="on-screen-threshold"){let n=this.getAttribute(i);r[i]=n}return r},{});this.renderer.setOptions(t)};dispatchLogEvent=e=>{let t=new CustomEvent("log",{detail:{message:e},bubbles:!0,composed:!0});this.dispatchEvent(t)};initializeRenderer(){if(this.renderer)return;let e=this.getOptions();this.renderer=new B({parentNode:this,logger:this.dispatchLogEvent,...e})}calculateDimensions(){let e=this.clientWidth??100,t=this.clientHeight??100;return{width:e,height:t}}getOptions(){let e={};for(let t of l.observedAttributes){let r=w(t);if(this.hasAttribute(r)){let i=this.getAttribute(r);e[t]={"":!0,true:!0,false:!1}[i+""]??i}}return e}setupResizeObserver(){this.parentElement&&(this.resizeObserver=new ResizeObserver(()=>{let e=this.calculateDimensions();this.storedDimensions=e,this.attemptSetSize()}),this.resizeObserver.observe(this))}setupIntersectionObserver(){this.intersectionObserver?.disconnect();let e=this.getAttribute("on-screen-threshold")||"50px";this.intersectionObserver=new IntersectionObserver(t=>{for(let r of t)this.isIntersecting=r.isIntersecting,this.isIntersecting&&this.attemptSetSize()},{rootMargin:`${e} ${e} ${e} ${e}`}),this.intersectionObserver.observe(this)}attemptSetSize(){!this.isIntersecting||!this.storedDimensions||(this.renderer?.setSize(this.storedDimensions.width,this.storedDimensions.height),this.storedDimensions=null)}get maxCarveUpScale(){return this.options["max-carve-up-scale"]}set maxCarveUpScale(e){this.options["max-carve-up-scale"]=e,this.renderer?.setOptions({maxCarveUpScale:e})}get scalingAxis(){return this.options["scaling-axis"]}set scalingAxis(e){this.options["scaling-axis"]=e,this.renderer?.setOptions({scalingAxis:e})}get showEnergyMap(){return this.options["show-energy-map"]}set showEnergyMap(e){this.options["show-energy-map"]=e,this.renderer?.setOptions({showEnergyMap:e})}get onScreenThreshold(){let e=this.getAttribute("on-screen-threshold")||"50px";return parseInt(e.replace("px",""),10)}};customElements.define("fluid-img",V);})();
//# sourceMappingURL=fluid-img-random.js.map
