var N=class extends Image{#e;constructor(e={}){super(),this.crossOrigin="Anonymous",this.#e=!!e.rotate}get width(){let e=this.#e?super.height:super.width;return e-e%2}get height(){return this.#e?super.width:super.height}},w=class{#e;#t;#r;#n;#a;constructor(e,t){this.#e=e,this.#n=t.rotate,this.#a=t.profiler,this.#t=this.#i(),this.#r=this.#t.then(r=>this.#s(r))}#i(){return new Promise((e,t)=>{let r=this.#e,n=new N({rotate:this.#n});n.onload=()=>e(n),n.onerror=()=>t(`Failed to load image: ${r}`),n.onabort=()=>t(`Image loading aborted: ${r}`),n.src=r})}#s(e){let t=this.#a;return new Promise(r=>{t?.start("loadImageData");let i=new OffscreenCanvas(e.width,e.height).getContext("2d");this.#n&&(i.translate(e.width,0),i.rotate(Math.PI/2)),i.drawImage(e,0,0);let s=i.getImageData(0,0,e.width,e.height);t?.end("loadImageData"),r(s)})}get src(){return this.#e}get image(){return this.#t}get imageData(){return this.#r}};var b="fluid-img";var H=g=>e=>{let t=g^e;return t^=t>>>16,t*=2246822507,t^=t>>>13,t*=3266489909,t^=t>>>16,t&1};function v(g,e,t=1){let r=g.length-e.length*t,n=g.constructor,i=new n(r),s=0,a=0,c=-1;for(let o of e){if(c===o)throw new Error("[deleteArrayIndices]: Duplicate index detected");if(c>o)throw new Error("[deleteArrayIndices]: Indices are not sorted");let h=o-a;h>0&&(i.set(g.subarray(a,o),s),s+=h),a=o+t,c=o}return a<g.length&&i.set(g.subarray(a),s),i}function G(g,e,t=!1){let{data:r,width:n,height:i}=g,s=e?new Array(i):new Uint8Array(n*i);for(let a=0;a<i;a++){let c=a*n,o=e?s[a]=new Uint8Array(n):s;for(let h=0;h<n;h++){let m=(c+h)*4,l=r[m],d=r[m+1],p=r[m+2],u=r[m+3],y;t?y=(l+d+p)/3*u/255:y=(.299*l+.587*d+.114*p)*u/255,o[e?h:c+h]=y}}return s}var R=class{#e;#t;#r;#n;#a;#i;constructor(e){this.#t=e.imageData.width,this.#r=e.imageData.height,this.#e=new Array(this.#r),this.#a=new Array(this.#r),this.#i=e.maskData,this.#n=G(e.imageData,!0),this.#h(),this.#e=this.#o()}#s(e,t){if(!this.#i)return 255;let r=this.#a[e][t];return this.#i[r]}#h(){for(let e=0;e<this.#r;e++){this.#a[e]=new Uint32Array(this.#t);for(let t=0;t<this.#t;t++)this.#a[e][t]=e*this.#t+t}}#o(e=this.#t,t=this.#r){let r=new Array(t);for(let n=0;n<t;n++){r[n]=new Uint16Array(e);let i=Math.max(0,n-1),s=Math.min(t-1,n+1),a=this.#n[i],c=this.#n[n],o=this.#n[s];for(let h=0;h<e;h++){let m=Math.max(0,h-1),l=Math.min(e-1,h+1),d=-a[m]+a[l]+-c[m]*2+c[l]*2+-o[m]+o[l],p=-a[m]+-a[h]*2+-a[l]+o[m]+o[h]*2+o[l],u=(d<0?-d:d)+(p<0?-p:p),y=this.#s(n,h);r[n][h]=u*(y/255)}}return r}get width(){return this.#t}get height(){return this.#r}get energyMap(){return this.#e}get originalIndices(){return this.#a}removeSeam(e){for(let r=0;r<this.#r;r++){let n=e[r];this.#e[r]=v(this.#e[r],[n]),this.#a[r]=v(this.#a[r],[n])}this.#t--;let t=(r,n)=>r<n?r:r+1;for(let r=0;r<this.#r;r++){let n=e[r],i=Math.max(0,r-1),s=Math.min(this.#r-1,r+1),a=this.#n[i],c=this.#n[r],o=this.#n[s],h=[];n>0&&h.push(n-1),n<this.#t&&h.push(n);for(let m of h){let l=Math.max(0,t(m-1,n)),d=Math.min(this.#n[0].length-1,t(m+1,n)),p=t(m,n),u=-a[l]+a[d]+-c[l]*2+c[d]*2+-o[l]+o[d],y=-a[l]+-a[p]*2+-a[d]+o[l]+o[p]*2+o[d],A=(u<0?-u:u)+(y<0?-y:y),f=this.#s(r,m);this.#e[r][m]=A+f}}}removeSeams(e){if(e.length===0)return;let t=e.length;for(let r=0;r<this.#r;r++){let n=e.map(i=>i[r]).sort((i,s)=>i-s);this.#e[r]=v(this.#e[r],n),this.#n[r]=v(this.#n[r],n),this.#a[r]=v(this.#a[r],n)}this.#t-=t,this.#e=this.#o()}getEnergyMapAsImageData(e=this.#t,t=this.#r){let r=this.#o(e,t),n=1/0,i=0;for(let o=0;o<t;o++)for(let h=0;h<e;h++){let m=r[o][h];m<n&&(n=m),m>i&&(i=m)}let s=i-n,a=new ImageData(e,t),c=a.data;for(let o=0;o<t;o++)for(let h=0;h<e;h++){let m=(o*e+h)*4,l=r[o][h],d=s>0?Math.round((l-n)/s*255):0;c[m]=d,c[m+1]=d,c[m+2]=d,c[m+3]=255}return a}};q("sobel",R);var j=new Map;function q(g,e){Promise.resolve().then(()=>{j.set(g,e)})}function Y(g){let e=g.algorithm??"sobel",t=j.get(e);if(!t)throw new Error(`[${b}] Energy map algorithm '${e}' is not registered or included in the build.`);return new t(g)}var T=class{impl;constructor(e){this.impl=Y(e)}get width(){return this.impl.width}get height(){return this.impl.height}get energyMap(){return this.impl.energyMap}get originalIndices(){return this.impl.originalIndices}removeSeam(e){return this.impl.removeSeam(e)}removeSeams(e){return this.impl.removeSeams(e)}getEnergyMapAsImageData(e,t){return this.impl.getEnergyMapAsImageData(e,t)}};var D=class{imageLoader;maskLoader;energyMapPromise;seamGrid=new Uint16Array;generatedSeams=0;constructor(e){this.imageLoader=e.imageLoader,this.maskLoader=e.maskLoader,this.energyMapPromise=this.createEnergyMap()}async getImageData(){return this.imageLoader.imageData}async getImage(){return this.imageLoader.image}async createEnergyMap(){let e=await this.imageLoader.imageData,t=await this.getMaskData();return this.seamGrid=new Uint16Array(e.width*e.height).fill(65535),new T({imageData:e,maskData:t})}async getMaskData(){if(!this.maskLoader)return;let e=await this.maskLoader.imageData;return G(e,!1)}async generateSeamGrid(e){let{width:t}=await this.imageLoader.image;if(t<e)throw new Error(`Cannot generate ${e} seams for image with width ${t}`);for(;this.generatedSeams<e;)await this.generateSeamBatch();return this.seamGrid}};var ne={batchPercentage:.05,minBatchSize:10},$=class extends D{connections=[];options;constructor(e){super(e),this.options={...ne,...e}}setBatchPercentage(e){this.options.batchPercentage=e}async generateSeamBatch(){let e=await this.energyMapPromise,t=e.originalIndices,r=e.width,n=e.height;this.generateConnections(r,n);let i=Array.from({length:r},(o,h)=>this.getSeam(e,h));i.sort((o,h)=>o.energy-h.energy);let s=Math.max(Math.ceil(r*this.options.batchPercentage)>>1<<1,Math.min(this.options.minBatchSize,r)),a=i.slice(0,s),c=this.generatedSeams;for(let o=0;o<a.length;o++)a[o].seam.forEach((m,l)=>{let d=t[l][m];if(this.seamGrid[d]!==65535)throw new Error("Seam overlap detected");this.seamGrid[d]=c}),c++;e.removeSeams(a.map(o=>o.seam)),this.generatedSeams+=a.length}generateConnections(e,t){let r=H(e*t+1);this.connections=Array.from({length:t},()=>new Int8Array(e));let n=e-1;for(let i=0;i<t;i++)for(let s=0;s<e;s++)s===n||r(i*e+s)?this.connections[i][s]=0:(this.connections[i][s]=1,this.connections[i][s+1]=-1,s++)}getSeam(e,t){let r=e.height,n=new Uint16Array(r),i=e.energyMap,s=0,a=t;for(let c=0;c<r;c++)n[c]=a=a+this.connections[c][a],s+=i[c][a];return{seam:n,energy:s}}};Q("random",$);var X=new Map;function Q(g,e){Promise.resolve().then(()=>{X.set(g,e)})}function K(g){let e=g.generator??"random",t=X.get(e);if(!t)throw new Error(`[${b}] Generator '${e}' is not registered or included in the build.`);return new t(g)}var C=class{#e;#t=new Map;#r=[];constructor(e){this.#e=e}start(e,t=0){this.#t.set(e,{startTime:performance.now(),minLoggingTime:t,totalNestedTime:0}),this.#r.push(e)}end(e){let{startTime:t,minLoggingTime:r,totalNestedTime:n}=this.#t.get(e),i=performance.now()-t;if(i<r)return;let s=this.#r.length;if(s>1){let a=this.#r[s-2],c=this.#t.get(a);c.totalNestedTime+=i}n>0?this.#e(`${e}: ${(i-n).toFixed(2)}ms (${i.toFixed(2)}ms)`):this.#e(`${e}: ${(i-n).toFixed(2)}ms`),this.#r.pop(),this.#t.delete(e)}};function W(g){return function(...t){if(!this.hasFailed)try{let r=g.apply(this,t);return r&&typeof r.catch=="function"?r.catch(n=>{this.handleFailure(n)}):r}catch(r){this.handleFailure(r)}}}function x(g){return g.replace(/([A-Z])/g,"-$1").toLowerCase()}var Z=g=>({getConstrainedNumber:(n,i,s=0,a=1)=>{let c=String(n),o=Number(g[x(c)]??i);if(o<s||o>a)throw new Error(`[${b}] \`${c}\` must be between ${s} and ${a}.`);return o},getBoolean:(n,i)=>{let s=String(n),a=g[x(s)];return a===null?!1:a!==void 0?!0:i},getEnumValue:(n,i,s)=>{let a=String(n),c=g[x(a)];return c==null?s:Object.values(i).includes(c)?c:(console.warn(`[${b}] Invalid value for ${a}: "${c}". Defaulting to "${s}".`),s)}});var I={Horizontal:"horizontal",Vertical:"vertical",Auto:"auto",Dual:"dual"};var U=class{canvas;ctx;height=0;width=0;options;internalHorizontalGenerator;internalVerticalGenerator;currentGenerator;isVertical;redrawQueued=!1;profiler;hasFailed=!1;parentNode;src;mask;cachedEnergyMapImageData=null;setOptions=W(this._setOptions).bind(this);redraw=W(this._redraw).bind(this);constructor(e){let{parentNode:t,src:r,mask:n,...i}=e;this.parentNode=t,this.src=r,this.mask=n;try{this.options=this.validateAndApplyDefaults(i),this.profiler=new C(this.options.logger),this.initializeCanvas(t)}catch(s){this.handleFailure(s)}}destroy(){this.canvas.remove()}get horizontalGenerator(){if(!this.internalHorizontalGenerator){let e=new w(this.src,{rotate:!1,profiler:this.profiler}),t=this.mask?new w(this.mask,{rotate:!1}):void 0;this.internalHorizontalGenerator=this.createGenerator({imageLoader:e,maskLoader:t})}return this.internalHorizontalGenerator}get verticalGenerator(){if(!this.internalVerticalGenerator){let e=new w(this.src,{rotate:!0,profiler:this.profiler}),t=this.mask?new w(this.mask,{rotate:!0}):void 0;this.internalVerticalGenerator=this.createGenerator({imageLoader:e,maskLoader:t})}return this.internalVerticalGenerator}determineCurrentGenerator(){return this.isVertical?this.verticalGenerator:this.horizontalGenerator}createGenerator(e){let t={...this.options,imageLoader:e.imageLoader,maskLoader:e.maskLoader};return K(t)}validateAndApplyDefaults(e){let{getBoolean:t,getConstrainedNumber:r,getEnumValue:n}=Z(e);return{...e,carvingPriority:r("carvingPriority",1),maxCarveUpSeamPercentage:r("maxCarveUpSeamPercentage",.6),maxCarveUpScale:r("maxCarveUpScale",10,1,10),maxCarveDownScale:r("maxCarveDownScale",1),scalingAxis:n("scalingAxis",I,I.Horizontal),logger:e.logger??(()=>{}),showEnergyMap:t("showEnergyMap",!1),demoMode:t("demoMode",!1)}}calculateDimensions(e){let{width:t,height:r}=this.options;if(t===void 0||r===void 0){let n=e.getBoundingClientRect();t=t??n.width,r=r??n.height}return{width:t,height:r}}initializeCanvas(e){let{width:t,height:r}=this.calculateDimensions(e);this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.canvas.width=this.width=t,this.canvas.height=this.height=r,this.canvas.style.display="block",e.appendChild(this.canvas),this.queueRedraw()}setSize(e,t){this.width=e,this.height=t,this.queueRedraw()}setWidth(e){this.width=e,this.queueRedraw()}setHeight(e){this.height=e,this.queueRedraw()}_setOptions(e){let t=this.options.showEnergyMap;this.options=this.validateAndApplyDefaults({...this.options,...e}),this.options.showEnergyMap!==t&&(this.cachedEnergyMapImageData=null),this.queueRedraw()}queueRedraw(){this.redrawQueued||(this.redrawQueued=!0,Promise.resolve().then(async()=>{await this.redraw(),this.redrawQueued=!1}))}determineCarvingParameters(e){let{carvingPriority:t,maxCarveUpSeamPercentage:r,maxCarveUpScale:n,maxCarveDownScale:i}=this.options,{width:s,height:a}=e,{isVertical:c,width:o,height:h}=this,m=c?h:o,l=c?o:h,d=m/l,p=Math.round(a*d),u=s-p;if(u===0)return{availableSeams:0,interpolationPixels:0,carveDown:!1};let y=Math.abs(u)*t,A=u>0?i:r,f=s*A,F=u>0?1:-1,E=u>0,M=Math.floor(Math.min(y,f))*F;if(E)return{availableSeams:M,interpolationPixels:0,carveDown:E};{let S=Math.round(a/l*m)-s,O=Math.floor(s*n)-s,z=Math.max(0,Math.min(S,O));return{availableSeams:-M,interpolationPixels:z,carveDown:E}}}async determineOrientation(){if(this.options.scalingAxis===I.Horizontal)return!1;if(this.options.scalingAxis===I.Vertical)return!0;let{width:e,height:t}=await this.horizontalGenerator.getImage(),r=e/t;return this.width/this.height>r}async refreshCachedArgs(){this.isVertical=await this.determineOrientation(),this.currentGenerator=this.determineCurrentGenerator()}async getEnergyMapImageData(){if(this.cachedEnergyMapImageData)return this.cachedEnergyMapImageData;let e=await this.currentGenerator.getImageData(),t=new T({imageData:e});return this.cachedEnergyMapImageData=t.getEnergyMapAsImageData(),this.cachedEnergyMapImageData}async getSourceImageData(){return this.options.showEnergyMap?await this.getEnergyMapImageData():await this.currentGenerator.getImageData()}async _redraw(){if(!this.width||!this.height)return;this.profiler.start("redraw"),await this.refreshCachedArgs();let e=await this.getSourceImageData(),{availableSeams:t,interpolationPixels:r,carveDown:n}=this.determineCarvingParameters(e),i;if(t===0)i=e;else{this.profiler.start("generateSeamGrid",1);let h=await this.currentGenerator.generateSeamGrid(Math.abs(t));this.profiler.end("generateSeamGrid"),n?i=this.filterPixels(e,h,t):i=this.interpolatePixels(e,h,t,r)}this.canvas.width=i.width,this.canvas.height=i.height,this.ctx.putImageData(i,0,0);let s=this.canvas.style,{isVertical:a,width:c,height:o}=this;s.transformOrigin="0 0",s.transform=a?"rotate(-90deg) translateX(-100%)":"",s.width=`${a?o:c}px`,s.height=`${a?c:o}px`,this.profiler.end("redraw")}interpolatePixels(e,t,r,n){let{width:i,height:s,data:a}=e,c=i+n,o=c*s*4,h=new Uint8ClampedArray(o),m=0,l=a.length/4,d=Math.floor(n/r),p=n%r,u=0;for(let y=0;y<l;y++){let A=t[y],f=y*4;if(A<r){let E=p>0&&A*p%r<p?d+1:d;if(u===0)for(let M=0;M<E;M++)h[m]=a[f],h[m+1]=a[f+1],h[m+2]=a[f+2],h[m+3]=a[f+3],m+=4;else{let M=(y-1)*4,k=a[M],S=a[M+1],L=a[M+2],O=a[M+3],_=a[f]-k,z=a[f+1]-S,J=a[f+2]-L,ee=a[f+3]-O,te=E+1;for(let B=0;B<E;B++){let P=(B+1)/te;h[m]=Math.round(k+_*P),h[m+1]=Math.round(S+z*P),h[m+2]=Math.round(L+J*P),h[m+3]=Math.round(O+ee*P),m+=4}}}h[m]=a[f],h[m+1]=a[f+1],h[m+2]=a[f+2],h[m+3]=a[f+3],m+=4,++u===i&&(u=0)}return m!==o&&console.error(`[${b}] Mismatch during interpolation. Wrote ${m} bytes but expected ${o}.`),new ImageData(h,c,s)}filterPixels(e,t,r){let{width:n,height:i,data:s}=e,a=n-r,c=a*i*4,o=new Uint8ClampedArray(c),h=s.length/4,m=0;for(let l=0;l<h;l++)if(t[l]>=r){let p=l*4;o[m]=s[p],o[m+1]=s[p+1],o[m+2]=s[p+2],o[m+3]=s[p+3],m+=4}return m!==c&&console.error(`[${b}] Mismatch in pixel buffer size. Expected ${c}, but got ${m}.`),new ImageData(o,a,i)}handleFailure(e){if(this.hasFailed)return;this.hasFailed=!0,console.error(`[${b}] A critical error occurred. Falling back to <img>.`,e),this.canvas?.remove();let t=document.createElement("img");t.src=this.src,t.style.width="100%",t.style.height="100%",t.style.display="block",this.parentNode.appendChild(t)}};var V=class g extends HTMLElement{renderer=null;resizeObserver=null;intersectionObserver=null;updateQueue=new Set;isIntersecting=!1;storedDimensions=null;options={};static destructiveProperties=new Set(["src","scaling-axis","mask","generator"]);constructor(){super()}static get observedAttributes(){return["src","mask","on-screen-threshold",...["generator","carvingPriority","maxCarveUpSeamPercentage","maxCarveUpScale","maxCarveDownScale","scalingAxis","showEnergyMap","mask"].map(x)]}connectedCallback(){this.setupResizeObserver(),this.setupIntersectionObserver()}disconnectedCallback(){this.renderer?.destroy(),this.renderer=null,this.resizeObserver?.disconnect(),this.resizeObserver=null,this.intersectionObserver?.disconnect(),this.intersectionObserver=null}attributeChangedCallback(e,t,r){t!==r&&(this.updateQueue.size||setTimeout(this.processUpdates),this.updateQueue.add(e))}processUpdates=()=>{let e=Array.from(this.updateQueue);if(this.updateQueue.clear(),e.some(r=>g.destructiveProperties.has(r))){this.renderer?.destroy(),this.renderer=null,this.initializeRenderer();return}if(e.includes("on-screen-threshold")&&this.setupIntersectionObserver(),!this.renderer)return;let t=e.reduce((r,n)=>{if(n!=="src"&&n!=="on-screen-threshold"){let i=this.getAttribute(n);r[n]=i}return r},{});this.renderer.setOptions(t)};dispatchLogEvent=e=>{let t=new CustomEvent("log",{detail:{message:e},bubbles:!0,composed:!0});this.dispatchEvent(t)};initializeRenderer(){if(this.renderer)return;let e=this.getOptions();this.renderer=new U({parentNode:this,logger:this.dispatchLogEvent,...e})}calculateDimensions(){let e=this.clientWidth??100,t=this.clientHeight??100;return{width:e,height:t}}getOptions(){let e={};for(let t of g.observedAttributes){let r=x(t);if(this.hasAttribute(r)){let n=this.getAttribute(r);e[t]={"":!0,true:!0,false:!1}[n+""]??n}}return e}setupResizeObserver(){this.parentElement&&(this.resizeObserver=new ResizeObserver(()=>{let e=this.calculateDimensions();this.storedDimensions=e,this.attemptSetSize()}),this.resizeObserver.observe(this))}setupIntersectionObserver(){this.intersectionObserver?.disconnect();let e=this.getAttribute("on-screen-threshold")||"50px";this.intersectionObserver=new IntersectionObserver(t=>{for(let r of t)this.isIntersecting=r.isIntersecting,this.isIntersecting&&this.attemptSetSize()},{rootMargin:`${e} ${e} ${e} ${e}`}),this.intersectionObserver.observe(this)}attemptSetSize(){!this.isIntersecting||!this.storedDimensions||(this.renderer?.setSize(this.storedDimensions.width,this.storedDimensions.height),this.storedDimensions=null)}get maxCarveUpScale(){return this.options["max-carve-up-scale"]}set maxCarveUpScale(e){this.options["max-carve-up-scale"]=e,this.renderer?.setOptions({maxCarveUpScale:e})}get scalingAxis(){return this.options["scaling-axis"]}set scalingAxis(e){this.options["scaling-axis"]=e,this.renderer?.setOptions({scalingAxis:e})}get showEnergyMap(){return this.options["show-energy-map"]}set showEnergyMap(e){this.options["show-energy-map"]=e,this.renderer?.setOptions({showEnergyMap:e})}get onScreenThreshold(){let e=this.getAttribute("on-screen-threshold")||"50px";return parseInt(e.replace("px",""),10)}};customElements.define("fluid-img",V);export{V as FluidImg};
//# sourceMappingURL=fluid-img-random.js.map
