"use strict";(()=>{var q=class extends Image{#r;constructor(e={}){super(),this.crossOrigin="Anonymous",this.#r=!!e.rotate}get width(){let e=this.#r?super.height:super.width;return e-e%2}get height(){return this.#r?super.width:super.height}},A=class{#r;#e;#t;#n;#a;constructor(e,t){this.#r=e,this.#n=t.rotate,this.#a=t.profiler,this.#e=this.#i(),this.#t=this.#e.then(r=>this.#s(r))}#i(){return new Promise((e,t)=>{let r=this.#r,n=new q({rotate:this.#n});n.onload=()=>e(n),n.onerror=()=>t(`Failed to load image: ${r}`),n.onabort=()=>t(`Image loading aborted: ${r}`),n.src=r})}#s(e){let t=this.#a;return new Promise(r=>{t?.start("loadImageData");let i=new OffscreenCanvas(e.width,e.height).getContext("2d");this.#n&&(i.translate(e.width,0),i.rotate(Math.PI/2)),i.drawImage(e,0,0);let s=i.getImageData(0,0,e.width,e.height);t?.end("loadImageData"),r(s)})}get src(){return this.#r}get image(){return this.#e}get imageData(){return this.#t}};function b(d,e,t=1){let r=d.length-e.length*t,n=d.constructor,i=new n(r),s=0,a=0,h=-1;for(let o of e){if(h===o)throw new Error("[deleteArrayIndices]: Duplicate index detected");if(h>o)throw new Error("[deleteArrayIndices]: Indices are not sorted");let c=o-a;c>0&&(i.set(d.subarray(a,o),s),s+=c),a=o+t,h=o}return a<d.length&&i.set(d.subarray(a),s),i}function O(d,e,t=!1){let{data:r,width:n,height:i}=d,s=e?new Array(i):new Uint8Array(n*i);for(let a=0;a<i;a++){let h=a*n,o=e?s[a]=new Uint8Array(n):s;for(let c=0;c<n;c++){let m=(h+c)*4,p=r[m],l=r[m+1],g=r[m+2],u=r[m+3],y;t?y=(p+l+g)/3*u/255:y=(.299*p+.587*l+.114*g)*u/255,o[e?c:h+c]=y}}return s}var R=class{#r;#e;#t;#n;#a;#i;constructor(e,t){this.#e=e.width,this.#t=e.height,this.#r=new Array(this.#t),this.#a=new Array(this.#t),this.#i=t,this.#n=O(e,!0),this.#h(),this.#r=this.#o()}#s(e,t){if(!this.#i)return 255;let r=this.#a[e][t];return this.#i[r]}#h(){for(let e=0;e<this.#t;e++){this.#a[e]=new Uint32Array(this.#e);for(let t=0;t<this.#e;t++)this.#a[e][t]=e*this.#e+t}}#o(e=this.#e,t=this.#t){let r=new Array(t);for(let n=0;n<t;n++){r[n]=new Uint16Array(e);let i=Math.max(0,n-1),s=Math.min(t-1,n+1),a=this.#n[i],h=this.#n[n],o=this.#n[s];for(let c=0;c<e;c++){let m=Math.max(0,c-1),p=Math.min(e-1,c+1),l=-a[m]+a[p]+-h[m]*2+h[p]*2+-o[m]+o[p],g=-a[m]+-a[c]*2+-a[p]+o[m]+o[c]*2+o[p],u=(l<0?-l:l)+(g<0?-g:g),y=this.#s(n,c);r[n][c]=u*(y/255)}}return r}get width(){return this.#e}get height(){return this.#t}get energyMap(){return this.#r}get originalIndices(){return this.#a}removeSeam(e){for(let r=0;r<this.#t;r++){let n=e[r];this.#r[r]=b(this.#r[r],[n]),this.#a[r]=b(this.#a[r],[n])}this.#e--;let t=(r,n)=>r<n?r:r+1;for(let r=0;r<this.#t;r++){let n=e[r],i=Math.max(0,r-1),s=Math.min(this.#t-1,r+1),a=this.#n[i],h=this.#n[r],o=this.#n[s],c=[];n>0&&c.push(n-1),n<this.#e&&c.push(n);for(let m of c){let p=Math.max(0,t(m-1,n)),l=Math.min(this.#n[0].length-1,t(m+1,n)),g=t(m,n),u=-a[p]+a[l]+-h[p]*2+h[l]*2+-o[p]+o[l],y=-a[p]+-a[g]*2+-a[l]+o[p]+o[g]*2+o[l],v=(u<0?-u:u)+(y<0?-y:y),f=this.#s(r,m);this.#r[r][m]=v+f}}}removeSeams(e){if(e.length===0)return;let t=e.length;for(let r=0;r<this.#t;r++){let n=e.map(i=>i[r]).sort((i,s)=>i-s);this.#r[r]=b(this.#r[r],n),this.#n[r]=b(this.#n[r],n),this.#a[r]=b(this.#a[r],n)}this.#e-=t,this.#r=this.#o()}getEnergyMapAsImageData(e=this.#e,t=this.#t){let r=this.#o(e,t),n=1/0,i=0;for(let o=0;o<t;o++)for(let c=0;c<e;c++){let m=r[o][c];m<n&&(n=m),m>i&&(i=m)}let s=i-n,a=new ImageData(e,t),h=a.data;for(let o=0;o<t;o++)for(let c=0;c<e;c++){let m=(o*e+c)*4,p=r[o][c],l=s>0?Math.round((p-n)/s*255):0;h[m]=l,h[m+1]=l,h[m+2]=l,h[m+3]=255}return a}};function H(d,e,t){return(e*t+d)*4}function he(d,e,t,r){if(d<0||d>=t||e<0||e>=Math.floor(r.length/(t*4)))return 0;let n=H(d,e,t);return .299*r[n]+.587*r[n+1]+.114*r[n+2]*r[n+3]/255}function T(d,e,t,r,n,i){if(d<0||d>=n||e<0||e>=Math.floor(i.length/(n*4))||t<0||t>=n||r<0||r>=Math.floor(i.length/(n*4)))return 0;let s=H(d,e,n),a=H(t,r,n),h=i[s]-i[a],o=i[s+1]-i[a+1],c=i[s+2]-i[a+2];return Math.sqrt(h*h+o*o+c*c)}var G=class{#r;#e;#t;#n;#a;#i;#s;constructor(e,t=1,r){this.#e=e.width,this.#t=e.height,this.#i=e,this.#s=t,this.#r=new Array(this.#t),this.#n=new Array(this.#t),this.#a=new Array(this.#t),this.#h(),this.#o(e),this.#r=this.#c()}#h(){for(let e=0;e<this.#t;e++){this.#a[e]=new Uint32Array(this.#e);for(let t=0;t<this.#e;t++)this.#a[e][t]=e*this.#e+t}}#o(e){for(let t=0;t<this.#t;t++){this.#n[t]=new Uint8Array(this.#e);for(let r=0;r<this.#e;r++)this.#n[t][r]=he(r,t,this.#e,e.data)}}#m(e,t){let r=Math.max(0,t-1),n=Math.min(this.#t-1,t+1),i=Math.max(0,e-1),s=Math.min(this.#e-1,e+1),a=this.#n[r],h=this.#n[t],o=this.#n[n],c=-a[i]+a[s]+-h[i]*2+h[s]*2+-o[i]+o[s],m=-a[i]+-a[e]*2+-a[s]+o[i]+o[e]*2+o[s];return(c<0?-c:c)+(m<0?-m:m)}#l(e,t){let r=this.#i.data,n=e-1,i=e+1,s=T(n,t,i,t,this.#e,r),a=t-1,h=t+1,o=T(e,a,e,h,this.#e,r),c=0;return n>=0&&a>=0&&(c+=T(n,a,i,t,this.#e,r)),i<this.#e&&h<this.#t&&(c+=T(i,h,n,t,this.#e,r)),s+o+c*.5}#c(e=this.#e,t=this.#t){let r=new Array(t);for(let n=0;n<t;n++){r[n]=new Uint16Array(e);for(let i=0;i<e;i++){let s=this.#m(i,n),a=this.#l(i,n),h=s+this.#s*a;r[n][i]=Math.min(65535,Math.max(0,Math.round(h)))}}return r}get width(){return this.#e}get height(){return this.#t}get energyMap(){return this.#r}get originalIndices(){return this.#a}removeSeam(e){for(let i=0;i<this.#t;i++){let s=e[i];this.#r[i]=b(this.#r[i],[s]),this.#a[i]=b(this.#a[i],[s])}this.#e--;let t=new ImageData(this.#e,this.#t),r=0;for(let i=0;i<this.#t;i++){let s=e[i];for(let a=0;a<this.#e+1;a++)if(a!==s){let h=(i*(this.#e+1)+a)*4;t.data[r]=this.#i.data[h],t.data[r+1]=this.#i.data[h+1],t.data[r+2]=this.#i.data[h+2],t.data[r+3]=this.#i.data[h+3],r+=4}}this.#i=t;let n=(i,s)=>i<s?i:i+1;for(let i=0;i<this.#t;i++){let s=e[i],a=[];s>0&&a.push(s-1),s<this.#e&&a.push(s);for(let h of a){let o=this.#m(h,i),c=this.#l(h,i),m=o+this.#s*c;this.#r[i][h]=Math.min(65535,Math.max(0,Math.round(m)))}}}removeSeams(e){if(e.length===0)return;let t=e.length;for(let i=0;i<this.#t;i++){let s=e.map(a=>a[i]).sort((a,h)=>a-h);this.#r[i]=b(this.#r[i],s),this.#n[i]=b(this.#n[i],s),this.#a[i]=b(this.#a[i],s)}this.#e-=t;let r=new ImageData(this.#e,this.#t),n=0;for(let i=0;i<this.#t;i++){let s=e.map(h=>h[i]).sort((h,o)=>h-o),a=0;for(let h=0;h<this.#e+t;h++){if(a<s.length&&h===s[a]){a++;continue}let o=(i*(this.#e+t)+h)*4;r.data[n]=this.#i.data[o],r.data[n+1]=this.#i.data[o+1],r.data[n+2]=this.#i.data[o+2],r.data[n+3]=this.#i.data[o+3],n+=4}}this.#i=r,this.#r=this.#c()}getEnergyMapAsImageData(e=this.#e,t=this.#t){let r=this.#c(e,t),n=1/0,i=0;for(let o=0;o<t;o++)for(let c=0;c<e;c++){let m=r[o][c];m<n&&(n=m),m>i&&(i=m)}let s=i-n,a=new ImageData(e,t),h=a.data;for(let o=0;o<t;o++)for(let c=0;c<e;c++){let m=(o*e+c)*4,p=r[o][c],l=s>0?Math.round((p-n)/s*255):0;h[m]=l,h[m+1]=l,h[m+2]=l,h[m+3]=255}return a}};function V(d,e,t){return(e*t+d)*4}function J(d,e,t,r){if(d<0||d>=t||e<0||e>=Math.floor(r.length/(t*4)))return 0;let n=V(d,e,t);return .299*r[n]+.587*r[n+1]+.114*r[n+2]*r[n+3]/255}function Z(d,e,t,r,n,i){if(d<0||d>=n||e<0||e>=Math.floor(i.length/(n*4))||t<0||t>=n||r<0||r>=Math.floor(i.length/(n*4)))return 0;let s=V(d,e,n),a=V(t,r,n),h=i[s]-i[a],o=i[s+1]-i[a+1],c=i[s+2]-i[a+2];return Math.sqrt(h*h+o*o+c*c)}function C(d,e,t,r,n){let i=0,s=0,a=0;for(let c=-t;c<=t;c++)for(let m=-t;m<=t;m++){let p=d+m,l=e+c;if(p>=0&&p<r&&l>=0&&l<Math.floor(n.length/(r*4))){let g=J(p,l,r,n);i+=g,s+=g*g,a++}}if(a<2)return 0;let h=i/a,o=s/a-h*h;return Math.sqrt(o)}var U=class{#r;#e;#t;#n;#a;#i;#s;#h;#o;constructor(e,t=5,r=10,n=20,i){this.#e=e.width,this.#t=e.height,this.#i=e,this.#s=t,this.#h=r,this.#o=n,this.#r=new Array(this.#t),this.#n=new Array(this.#t),this.#a=new Array(this.#t),this.#m(),this.#l(e),this.#r=this.#d()}#m(){for(let e=0;e<this.#t;e++){this.#a[e]=new Uint32Array(this.#e);for(let t=0;t<this.#e;t++)this.#a[e][t]=e*this.#e+t}}#l(e){for(let t=0;t<this.#t;t++){this.#n[t]=new Uint8Array(this.#e);for(let r=0;r<this.#e;r++)this.#n[t][r]=J(r,t,this.#e,e.data)}}#c(e,t){let r=Math.max(0,t-1),n=Math.min(this.#t-1,t+1),i=Math.max(0,e-1),s=Math.min(this.#e-1,e+1),a=this.#n[r],h=this.#n[t],o=this.#n[n],c=-a[i]+a[s]+-h[i]*2+h[s]*2+-o[i]+o[s],m=-a[i]+-a[e]*2+-a[s]+o[i]+o[e]*2+o[s];return(c<0?-c:c)+(m<0?-m:m)}#g(e,t){let r=this.#i.data,n=e-1,i=e+1,s=Z(n,t,i,t,this.#e,r),a=t-1,h=t+1,o=Z(e,a,e,h,this.#e,r);return s+o}#u(e,t){let r=this.#i.data,n=this.#c(e,t);if(n<this.#o*.3)return 0;let i=C(e-3,t,2,this.#e,r),s=C(e+3,t,2,this.#e,r),a=C(e,t-3,2,this.#e,r),h=C(e,t+3,2,this.#e,r),o=0,c=Math.min(i,s,a,h);if(c<this.#h*.5){let g=Math.max(0,(this.#h*.5-c)/(this.#h*.5));o=Math.max(o,g*.3)}let m=Math.abs(i-s),p=Math.abs(a-h),l=Math.max(m,p);if(l>this.#h*4&&n>this.#o){let g=Math.min(1,l/(this.#h*8));o=Math.max(o,g*.2)}if(n>this.#o*2.5){let g=Math.min(1,n/(this.#o*4));o=Math.max(o,g*.15)}if(o>0){let g=Math.min(1,n/(this.#o*2));return o*g*200}return 0}#d(e=this.#e,t=this.#t){let r=new Array(t);for(let n=0;n<t;n++){r[n]=new Uint16Array(e);for(let i=0;i<e;i++){let s=this.#c(i,n),a=this.#g(i,n),h=this.#u(i,n),o=s+a+this.#s*h;r[n][i]=Math.min(65535,Math.max(0,Math.round(o)))}}return r}get width(){return this.#e}get height(){return this.#t}get energyMap(){return this.#r}get originalIndices(){return this.#a}removeSeam(e){for(let n=0;n<this.#t;n++){let i=e[n];this.#r[n]=b(this.#r[n],[i]),this.#a[n]=b(this.#a[n],[i])}this.#e--;let t=new ImageData(this.#e,this.#t),r=0;for(let n=0;n<this.#t;n++){let i=e[n];for(let s=0;s<this.#e+1;s++)if(s!==i){let a=(n*(this.#e+1)+s)*4;t.data[r]=this.#i.data[a],t.data[r+1]=this.#i.data[a+1],t.data[r+2]=this.#i.data[a+2],t.data[r+3]=this.#i.data[a+3],r+=4}}this.#i=t;for(let n=0;n<this.#t;n++){let i=e[n],s=[];i>0&&s.push(i-1),i<this.#e&&s.push(i);for(let a of s){let h=this.#c(a,n),o=this.#g(a,n),c=this.#u(a,n),m=h+o+this.#s*c;this.#r[n][a]=Math.min(65535,Math.max(0,Math.round(m)))}}}removeSeams(e){if(e.length===0)return;let t=e.length;for(let i=0;i<this.#t;i++){let s=e.map(a=>a[i]).sort((a,h)=>a-h);this.#r[i]=b(this.#r[i],s),this.#n[i]=b(this.#n[i],s),this.#a[i]=b(this.#a[i],s)}this.#e-=t;let r=new ImageData(this.#e,this.#t),n=0;for(let i=0;i<this.#t;i++){let s=e.map(h=>h[i]).sort((h,o)=>h-o),a=0;for(let h=0;h<this.#e+t;h++){if(a<s.length&&h===s[a]){a++;continue}let o=(i*(this.#e+t)+h)*4;r.data[n]=this.#i.data[o],r.data[n+1]=this.#i.data[o+1],r.data[n+2]=this.#i.data[o+2],r.data[n+3]=this.#i.data[o+3],n+=4}}this.#i=r,this.#r=this.#d()}getEnergyMapAsImageData(e=this.#e,t=this.#t){let r=this.#d(e,t),n=1/0,i=0;for(let o=0;o<t;o++)for(let c=0;c<e;c++){let m=r[o][c];m<n&&(n=m),m>i&&(i=m)}let s=i-n,a=new ImageData(e,t),h=a.data;for(let o=0;o<t;o++)for(let c=0;c<e;c++){let m=(o*e+c)*4,p=r[o][c],l=s>0?Math.round((p-n)/s*255):0;h[m]=l,h[m+1]=l,h[m+2]=l,h[m+3]=255}return a}};var ce="sobel",k={dual:{forwardEnergyWeight:1},"boundary-aware":{boundaryPenaltyWeight:5,uniformityThreshold:10,edgeThreshold:20},sobel:{}};function me(d,e,t){switch(d){case"sobel":return new R(e,t);case"dual":return new G(e,k.dual.forwardEnergyWeight,t);case"boundary-aware":return new U(e,k["boundary-aware"].boundaryPenaltyWeight,k["boundary-aware"].uniformityThreshold,k["boundary-aware"].edgeThreshold,t);default:let r=d;throw new Error(`Unknown energy map algorithm: ${d}`)}}var L=class{impl;constructor(e,t){this.impl=me(ce,e,t)}get width(){return this.impl.width}get height(){return this.impl.height}get energyMap(){return this.impl.energyMap}get originalIndices(){return this.impl.originalIndices}removeSeam(e){return this.impl.removeSeam(e)}removeSeams(e){return this.impl.removeSeams(e)}getEnergyMapAsImageData(e,t){return this.impl.getEnergyMapAsImageData(e,t)}};var D=class{imageLoader;maskLoader;energyMapPromise;seamGrid=new Uint16Array;generatedSeams=0;constructor(e){this.imageLoader=e.imageLoader,this.maskLoader=e.maskLoader,this.energyMapPromise=this.createEnergyMap()}async createEnergyMap(){let e=await this.imageLoader.imageData,t=await this.getMaskData();return this.seamGrid=new Uint16Array(e.width*e.height).fill(65535),new L(e,t)}async getMaskData(){if(!this.maskLoader)return;let e=await this.maskLoader.imageData;return O(e,!1)}async generateSeamGrid(e){let{width:t}=await this.imageLoader.image;if(t<e)throw new Error(`Cannot generate ${e} seams for image with width ${t}`);for(;this.generatedSeams<e;)await this.generateSeamBatch();return this.seamGrid}};var le={constrainTo16Bit:!1,constrainToDiagonals:!1,accumulateUp:!1},z=class{#r;#e;#t;#n;constructor(e){this.#r={...le,...e},this.#t=e.energyMap.width,this.#n=e.energyMap.height,this.#e=this.computeMinimalEnergyMap()}computeMinimalEnergyMap(){let{energyMap:e,constrainTo16Bit:t,constrainToDiagonals:r,accumulateUp:n}=this.#r,{width:i,height:s}=e,a=new Array(s),h=n?s-1:0,o=n?-1:s,c=n?-1:1,m=t?s/256:1,p=t?Math.ceil(Math.log2(m)):0,l=e.energyMap;a[h]=new(t?Uint16Array:Uint32Array)(l[h]);for(let g=h+c;g!==o;g+=c){a[g]=new(t?Uint16Array:Uint32Array)(i);for(let u=0;u<i;u++){let y=l[g][u],v=a[g-c][u-1]??1/0,f=a[g-c][u+1]??1/0,I=r?1/0:a[g-c][u],x=Math.min(v,f,I);a[g][u]=y+x>>p}}return a}removeSeams(e){if(e.length!==0){for(let t=0;t<this.#n;t++){let r=e.map(n=>n[t]).sort((n,i)=>n-i);this.#e[t]=b(this.#e[t],r)}this.#t-=e.length}}get minimalEnergyMap(){return this.#e}};var B=class{timing;values;head;tail;windowSize;time;constructor(e,t=1e3,r=Uint16Array){this.windowSize=e,this.timing=new Uint16Array(t),this.values=new r(t),this.tail=0,this.head=0,this.time=0}addAndGetMax(e){for(this.time++;this.timing[this.tail]<=this.time-this.windowSize&&this.head>this.tail;)this.tail++;for(;this.values[this.head-1]<=e&&this.head>this.tail;)this.head--;return this.head>=this.timing.length&&(this.timing.set(this.timing.subarray(this.tail,this.head),0),this.values.set(this.values.subarray(this.tail,this.head),0),this.head=this.head-this.tail,this.tail=0),this.values[this.head]=e,this.timing[this.head]=this.time,this.head++,this.values[this.tail]}};var de={batchPercentage:.1,minBatchSize:10},N=class extends D{options;constructor(e){super(e),this.options={...de,...e}}setBatchPercentage(e){this.options.batchPercentage=e}async generateSeamBatch(){let e=await this.energyMapPromise,t=e.originalIndices,r=e.width,n=e.height,s=new z({energyMap:e,accumulateUp:!0}).minimalEnergyMap,a=[],h=e.energyMap;for(let l=0;l<r;l++){let g=h[0][l];a.push({path:new Uint16Array(n),energy:g,slidingWindowMaximum:new B(1)}),a[l].path[0]=l}let o=a;for(let l=1;l<n;l++){let g=[];for(let u=0;u<r;u++){let y=o[u];if(u===r-1){y.path[l]=u,y.energy+=y.slidingWindowMaximum.addAndGetMax(h[l][u]),g[u]=y;continue}let v=o[u+1],f=y.energy<v.energy,I=s[l][u]<s[l][u+1];f===I?(y.path[l]=u,y.energy+=y.slidingWindowMaximum.addAndGetMax(h[l][u]),g[u]=y):(y.path[l]=u+1,y.energy+=y.slidingWindowMaximum.addAndGetMax(h[l][u+1]),g[u+1]=y,v.path[l]=u,v.energy+=v.slidingWindowMaximum.addAndGetMax(h[l][u]),g[u]=v,u++)}o=g}a.sort((l,g)=>l.energy-g.energy);let c=Math.max(Math.ceil(r*this.options.batchPercentage)>>1<<1,Math.min(this.options.minBatchSize,r)),m=a.slice(0,c),p=this.generatedSeams;for(let l=0;l<m.length;l++)m[l].path.forEach((u,y)=>{let v=t[y][u];if(this.seamGrid[v]!==65535)throw new Error("Seam overlap detected");this.seamGrid[v]=p}),p++;e.removeSeams(m.map(l=>l.path)),this.generatedSeams+=m.length}};function ee(d,e){return!e||e==="predictive"?new N(d):null}function te(d){let e=ee(d,d.generator)||ee(d);if(!e)throw new Error("[Fluid-Img] No generators are available.");return e}var $=class{#r;#e=new Map;#t=[];constructor(e){this.#r=e}start(e,t=0){this.#e.set(e,{startTime:performance.now(),minLoggingTime:t,totalNestedTime:0}),this.#t.push(e)}end(e){let{startTime:t,minLoggingTime:r,totalNestedTime:n}=this.#e.get(e),i=performance.now()-t;if(i<r)return;let s=this.#t.length;if(s>1){let a=this.#t[s-2],h=this.#e.get(a);h.totalNestedTime+=i}n>0?this.#r(`${e}: ${(i-n).toFixed(2)}ms (${i.toFixed(2)}ms)`):this.#r(`${e}: ${(i-n).toFixed(2)}ms`),this.#t.pop(),this.#e.delete(e)}};function _(d){return function(...t){if(!this.hasFailed)try{let r=d.apply(this,t);return r&&typeof r.catch=="function"?r.catch(n=>{this.handleFailure(n)}):r}catch(r){this.handleFailure(r)}}}function M(d){return d.replace(/([A-Z])/g,"-$1").toLowerCase()}var E="Fluid-Img";var re=d=>({getConstrainedNumber:(n,i,s=0,a=1)=>{let h=String(n),o=Number(d[M(h)]??i);if(o<s||o>a)throw new Error(`[${E}] \`${h}\` must be between ${s} and ${a}.`);return o},getBoolean:(n,i)=>{let s=String(n),a=d[M(s)];return a===null?!1:a!==void 0?!0:i},getEnumValue:(n,i,s)=>{let a=String(n),h=d[M(a)];return h==null?s:Object.values(i).includes(h)?h:(console.warn(`[${E}] Invalid value for ${a}: "${h}". Defaulting to "${s}".`),s)}});var j={Horizontal:"horizontal",Vertical:"vertical",Auto:"auto",Dual:"dual"};var F=class{canvas;ctx;height=0;width=0;imageLoader;maskLoader;options;generator;redrawQueued=!1;profiler;hasFailed=!1;parentNode;src;mask;cachedEnergyMapImageData=null;setOptions=_(this._setOptions).bind(this);redraw=_(this._redraw).bind(this);constructor(e){let{parentNode:t,src:r,mask:n,...i}=e;this.parentNode=t,this.src=r,this.mask=n;try{this.options=this.validateAndApplyDefaults(i);let s=this.options.scalingAxis==="vertical";this.profiler=new $(this.options.logger),this.imageLoader=new A(r,{rotate:s,profiler:this.profiler}),this.mask&&(this.maskLoader=new A(this.mask,{rotate:s})),this.generator=this.createGenerator(),this.initializeCanvas(t)}catch(s){this.handleFailure(s)}}destroy(){this.canvas.remove()}createGenerator(){let e={...this.options,imageLoader:this.imageLoader,maskLoader:this.maskLoader};return te(e)}validateAndApplyDefaults(e){let{getBoolean:t,getConstrainedNumber:r,getEnumValue:n}=re(e);return{...e,carvingPriority:r("carvingPriority",1),maxCarveUpSeamPercentage:r("maxCarveUpSeamPercentage",.6),maxCarveUpScale:r("maxCarveUpScale",10,1,10),maxCarveDownScale:r("maxCarveDownScale",1),scalingAxis:n("scalingAxis",j,j.Horizontal),logger:e.logger??(()=>{}),showEnergyMap:t("showEnergyMap",!1),demoMode:t("demoMode",!1)}}calculateDimensions(e){let{width:t,height:r}=this.options;if(t===void 0||r===void 0){let n=e.getBoundingClientRect();t=t??n.width,r=r??n.height}return{width:t,height:r}}initializeCanvas(e){let{width:t,height:r}=this.calculateDimensions(e);this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.canvas.width=this.width=t,this.canvas.height=this.height=r,this.canvas.style.display="block",e.appendChild(this.canvas),this.queueRedraw()}setSize(e,t){this.width=e,this.height=t,this.queueRedraw()}setWidth(e){this.width=e,this.queueRedraw()}setHeight(e){this.height=e,this.queueRedraw()}_setOptions(e){let t=this.options.showEnergyMap;this.options=this.validateAndApplyDefaults({...this.options,...e}),this.options.showEnergyMap!==t&&(this.cachedEnergyMapImageData=null),this.queueRedraw()}queueRedraw(){this.redrawQueued||(this.redrawQueued=!0,Promise.resolve().then(async()=>{await this.redraw(),this.redrawQueued=!1}))}determineCarvingParameters(e){let{carvingPriority:t,maxCarveUpSeamPercentage:r,maxCarveUpScale:n,maxCarveDownScale:i}=this.options,{width:s,height:a}=e,h=this.width/this.height,o=Math.round(a*h),c=s-o;if(c===0)return{availableSeams:0,interpolationPixels:0,carveDown:!1};let m=Math.abs(c)*t,p=c>0?i:r,l=s*p,g=c>0?1:-1,u=c>0,y=Math.floor(Math.min(m,l))*g;if(u)return{availableSeams:y,interpolationPixels:0,carveDown:u};{let f=Math.round(a/this.height*this.width)-s,x=Math.floor(s*n)-s,S=Math.max(0,Math.min(f,x));return{availableSeams:-y,interpolationPixels:S,carveDown:u}}}async getEnergyMapImageData(){if(this.cachedEnergyMapImageData)return this.cachedEnergyMapImageData;let e=await this.imageLoader.imageData,t=new L(e);return this.cachedEnergyMapImageData=t.getEnergyMapAsImageData(),this.cachedEnergyMapImageData}async getSourceImageData(){return this.options.showEnergyMap?await this.getEnergyMapImageData():await this.imageLoader.imageData}async _redraw(){if(!this.width||!this.height)return;this.profiler.start("redraw");let e=await this.getSourceImageData(),{availableSeams:t,interpolationPixels:r,carveDown:n}=this.determineCarvingParameters(e),i;if(t===0)i=e;else{this.profiler.start("generateSeamGrid",1);let h=await this.generator.generateSeamGrid(t);this.profiler.end("generateSeamGrid"),n?i=this.filterPixels(e,h,t):i=this.interpolatePixels(e,h,t,r)}this.canvas.width=i.width,this.canvas.height=i.height,this.ctx.putImageData(i,0,0);let s=this.canvas.style,a=this.options.scalingAxis==="vertical";s.transformOrigin="0 0",s.transform=a?"rotate(-90deg) translateX(-100%)":"",s.width=`${a?this.height:this.width}px`,s.height=`${a?this.width:this.height}px`,this.profiler.end("redraw")}interpolatePixels(e,t,r,n){let{width:i,height:s,data:a}=e,h=i+n,o=h*s*4,c=new Uint8ClampedArray(o),m=0,p=a.length/4,l=Math.floor(n/r),g=n%r,u=0;for(let y=0;y<p;y++){let v=t[y],f=y*4;if(v<r){let x=g>0&&v*g%r<g?l+1:l;if(u===0)for(let w=0;w<x;w++)c[m]=a[f],c[m+1]=a[f+1],c[m+2]=a[f+2],c[m+3]=a[f+3],m+=4;else{let w=(y-1)*4,S=a[w],X=a[w+1],Y=a[w+2],K=a[w+3],ne=a[f]-S,ie=a[f+1]-X,ae=a[f+2]-Y,se=a[f+3]-K,oe=x+1;for(let W=0;W<x;W++){let P=(W+1)/oe;c[m]=Math.round(S+ne*P),c[m+1]=Math.round(X+ie*P),c[m+2]=Math.round(Y+ae*P),c[m+3]=Math.round(K+se*P),m+=4}}}c[m]=a[f],c[m+1]=a[f+1],c[m+2]=a[f+2],c[m+3]=a[f+3],m+=4,++u===i&&(u=0)}return m!==o&&console.error(`[${E}] Mismatch during interpolation. Wrote ${m} bytes but expected ${o}.`),new ImageData(c,h,s)}filterPixels(e,t,r){let{width:n,height:i,data:s}=e,a=n-r,h=a*i*4,o=new Uint8ClampedArray(h),c=s.length/4,m=0;for(let p=0;p<c;p++)if(t[p]>=r){let g=p*4;o[m]=s[g],o[m+1]=s[g+1],o[m+2]=s[g+2],o[m+3]=s[g+3],m+=4}return m!==h&&console.error(`[${E}] Mismatch in pixel buffer size. Expected ${h}, but got ${m}.`),new ImageData(o,a,i)}handleFailure(e){if(this.hasFailed)return;this.hasFailed=!0,console.error(`[${E}] A critical error occurred. Falling back to <img>.`,e),this.canvas?.remove();let t=document.createElement("img");t.src=this.src,t.style.width="100%",t.style.height="100%",t.style.display="block",this.parentNode.appendChild(t)}};var Q=class d extends HTMLElement{renderer=null;resizeObserver=null;intersectionObserver=null;updateQueue=new Set;isIntersecting=!1;storedDimensions=null;options={};constructor(){super()}static get observedAttributes(){return["src","mask","on-screen-threshold",...["generator","carvingPriority","maxCarveUpSeamPercentage","maxCarveUpScale","maxCarveDownScale","scalingAxis","showEnergyMap","mask"].map(M)]}connectedCallback(){this.setupResizeObserver(),this.setupIntersectionObserver()}disconnectedCallback(){this.renderer?.destroy(),this.renderer=null,this.resizeObserver?.disconnect(),this.resizeObserver=null,this.intersectionObserver?.disconnect(),this.intersectionObserver=null}attributeChangedCallback(e,t,r){t!==r&&(this.updateQueue.size||setTimeout(this.processUpdates),this.updateQueue.add(e))}processUpdates=()=>{let e=Array.from(this.updateQueue);if(this.updateQueue.clear(),e.includes("src")||e.includes("scaling-axis")||e.includes("mask")){this.renderer?.destroy(),this.renderer=null,this.initializeRenderer();return}if(e.includes("on-screen-threshold")&&this.setupIntersectionObserver(),!this.renderer)return;let t=e.reduce((r,n)=>{if(n!=="src"&&n!=="on-screen-threshold"){let i=this.getAttribute(n);r[n]=i}return r},{});this.renderer.setOptions(t)};dispatchLogEvent=e=>{let t=new CustomEvent("log",{detail:{message:e},bubbles:!0,composed:!0});this.dispatchEvent(t)};initializeRenderer(){if(this.renderer)return;let e=this.getOptions();this.renderer=new F({parentNode:this,logger:this.dispatchLogEvent,...e})}calculateDimensions(){let e=this.clientWidth??100,t=this.clientHeight??100;return{width:e,height:t}}getOptions(){let e={};for(let t of d.observedAttributes){let r=M(t);if(this.hasAttribute(r)){let n=this.getAttribute(r);e[t]={"":!0,true:!0,false:!1}[n+""]??n}}return e}setupResizeObserver(){this.parentElement&&(this.resizeObserver=new ResizeObserver(()=>{let e=this.calculateDimensions();this.storedDimensions=e,this.attemptSetSize()}),this.resizeObserver.observe(this))}setupIntersectionObserver(){this.intersectionObserver?.disconnect();let e=this.getAttribute("on-screen-threshold")||"50px";this.intersectionObserver=new IntersectionObserver(t=>{for(let r of t)this.isIntersecting=r.isIntersecting,this.isIntersecting&&this.attemptSetSize()},{rootMargin:`${e} ${e} ${e} ${e}`}),this.intersectionObserver.observe(this)}attemptSetSize(){!this.isIntersecting||!this.storedDimensions||(this.renderer?.setSize(this.storedDimensions.width,this.storedDimensions.height),this.storedDimensions=null)}get maxCarveUpScale(){return this.options["max-carve-up-scale"]}set maxCarveUpScale(e){this.options["max-carve-up-scale"]=e,this.renderer?.setOptions({maxCarveUpScale:e})}get scalingAxis(){return this.options["scaling-axis"]}set scalingAxis(e){this.options["scaling-axis"]=e,this.renderer?.setOptions({scalingAxis:e})}get showEnergyMap(){return this.options["show-energy-map"]}set showEnergyMap(e){this.options["show-energy-map"]=e,this.renderer?.setOptions({showEnergyMap:e})}get onScreenThreshold(){let e=this.getAttribute("on-screen-threshold")||"50px";return parseInt(e.replace("px",""),10)}};customElements.define("fluid-img",Q);})();
//# sourceMappingURL=fluid-img-predictive.js.map
