"use strict";(()=>{var j=class extends Image{#t;constructor(t={}){super(),this.crossOrigin="Anonymous",this.#t=!!t.rotate}get width(){let t=this.#t?super.height:super.width;return t-t%2}get height(){return this.#t?super.width:super.height}},A=class{#t;#e;#r;#n;#i;constructor(t,e){this.#t=t,this.#n=e.rotate,this.#i=e.i,this.#e=this.#a(),this.#r=this.#e.then(r=>this.#s(r))}#a(){return new Promise((t,e)=>{let r=this.#t,n=new j({rotate:this.#n});n.onload=()=>t(n),n.onerror=()=>e(`Failed to load image: ${r}`),n.onabort=()=>e(`Image loading aborted: ${r}`),n.src=r})}#s(t){let e=this.#i;return new Promise(r=>{e?.start("loadImageData");let a=new OffscreenCanvas(t.width,t.height).getContext("2d");this.#n&&(a.translate(t.width,0),a.rotate(Math.PI/2)),a.drawImage(t,0,0);let s=a.getImageData(0,0,t.width,t.height);e?.end("loadImageData"),r(s)})}get src(){return this.#t}get z(){return this.#e}get t(){return this.#r}};var E="fluid-img";function x(u,t,e=1){let r=u.length-t.length*e,n=u.constructor,a=new n(r),s=0,i=0,p=-1;for(let c of t){if(p===c)throw new Error("[deleteArrayIndices]: Duplicate index detected");if(p>c)throw new Error("[deleteArrayIndices]: Indices are not sorted");let o=c-i;o>0&&(a.set(u.subarray(i,c),s),s+=o),i=c+e,p=c}return i<u.length&&a.set(u.subarray(i),s),a}function B(u,t,e=!1){let{data:r,width:n,height:a}=u,s=t?new Array(a):new Uint8Array(n*a);for(let i=0;i<a;i++){let p=i*n,c=t?s[i]=new Uint8Array(n):s;for(let o=0;o<n;o++){let h=(p+o)*4,y=r[h],m=r[h+1],g=r[h+2],l=r[h+3],d;e?d=(y+m+g)/3*l/255:d=(.299*y+.587*m+.114*g)*l/255,c[t?o:p+o]=d}}return s}var N=class{#t;#e;#r;#n;#i;#a;constructor(t){this.#e=t.t.width,this.#r=t.t.height,this.#t=new Array(this.#r),this.#i=new Array(this.#r),this.#a=t.nt,this.#n=B(t.t,!0),this.#h(),this.#t=this.#o()}#s(t,e){if(!this.#a)return 255;let r=this.#i[t][e];return this.#a[r]}#h(){for(let t=0;t<this.#r;t++){this.#i[t]=new Uint32Array(this.#e);for(let e=0;e<this.#e;e++)this.#i[t][e]=t*this.#e+e}}#o(t=this.#e,e=this.#r){let r=new Array(e);for(let n=0;n<e;n++){r[n]=new Uint16Array(t);let a=Math.max(0,n-1),s=Math.min(e-1,n+1),i=this.#n[a],p=this.#n[n],c=this.#n[s];for(let o=0;o<t;o++){let h=Math.max(0,o-1),y=Math.min(t-1,o+1),m=-i[h]+i[y]+-p[h]*2+p[y]*2+-c[h]+c[y],g=-i[h]+-i[o]*2+-i[y]+c[h]+c[o]*2+c[y],l=(m<0?-m:m)+(g<0?-g:g),d=this.#s(n,o);r[n][o]=l*(d/255)}}return r}get width(){return this.#e}get height(){return this.#r}get r(){return this.#t}get p(){return this.#i}x(t){for(let r=0;r<this.#r;r++){let n=t[r];this.#t[r]=x(this.#t[r],[n]),this.#i[r]=x(this.#i[r],[n])}this.#e--;let e=(r,n)=>r<n?r:r+1;for(let r=0;r<this.#r;r++){let n=t[r],a=Math.max(0,r-1),s=Math.min(this.#r-1,r+1),i=this.#n[a],p=this.#n[r],c=this.#n[s],o=[];n>0&&o.push(n-1),n<this.#e&&o.push(n);for(let h of o){let y=Math.max(0,e(h-1,n)),m=Math.min(this.#n[0].length-1,e(h+1,n)),g=e(h,n),l=-i[y]+i[m]+-p[y]*2+p[m]*2+-c[y]+c[m],d=-i[y]+-i[g]*2+-i[m]+c[y]+c[g]*2+c[m],b=(l<0?-l:l)+(d<0?-d:d),v=this.#s(r,h);this.#t[r][h]=b+v}}}c(t){if(t.length===0)return;let e=t.length;for(let r=0;r<this.#r;r++){let n=t.map(a=>a[r]).sort((a,s)=>a-s);this.#t[r]=x(this.#t[r],n),this.#n[r]=x(this.#n[r],n),this.#i[r]=x(this.#i[r],n)}this.#e-=e,this.#t=this.#o()}g(t=this.#e,e=this.#r){let r=this.#o(t,e),n=1/0,a=0;for(let c=0;c<e;c++)for(let o=0;o<t;o++){let h=r[c][o];h<n&&(n=h),h>a&&(a=h)}let s=a-n,i=new ImageData(t,e),p=i.data;for(let c=0;c<e;c++)for(let o=0;o<t;o++){let h=(c*t+o)*4,y=r[c][o],m=s>0?Math.round((y-n)/s*255):0;p[h]=m,p[h+1]=m,p[h+2]=m,p[h+3]=255}return i}};K("sobel",N);var Z=new Map;function K(u,t){Promise.resolve().then(()=>{Z.set(u,t)})}function J(u){let t=u.algorithm??"sobel",e=Z.get(t);if(!e)throw new Error(`[${E}] Energy map algorithm '${t}' is not registered or included in the build.`);return new e(u)}var $=class{o;constructor(t){this.o=J(t)}get width(){return this.o.width}get height(){return this.o.height}get r(){return this.o.r}get p(){return this.o.p}x(t){return this.o.x(t)}c(t){return this.o.c(t)}g(t,e){return this.o.g(t,e)}};var R=class{a;h;S;l=new Uint16Array;y=0;constructor(t){this.a=t.a,this.h=t.h,this.S=this.it()}async getImageData(){return this.a.t}async at(){return this.a.z}async it(){let t=await this.a.t,e=await this.st();return this.l=new Uint16Array(t.width*t.height).fill(65535),new $({t,nt:e})}async st(){if(!this.h)return;let t=await this.h.t;return B(t,!1)}async ot(t){let{width:e}=await this.a.z;if(e<t)throw new Error(`Cannot generate ${t} seams for image with width ${e}`);for(;this.y<t;)await this.V();return this.l}};var ht={pt:!1,lt:!1,q:!1},L=class{#t;#e;#r;#n;constructor(t){this.#t={...ht,...t},this.#r=t.r.width,this.#n=t.r.height,this.#e=this.gt()}gt(){let{r:t,pt:e,lt:r,q:n}=this.#t,{width:a,height:s}=t,i=new Array(s),p=n?s-1:0,c=n?-1:s,o=n?-1:1,h=e?s/256:1,y=e?Math.ceil(Math.log2(h)):0,m=t.r;i[p]=new(e?Uint16Array:Uint32Array)(m[p]);for(let g=p+o;g!==c;g+=o){i[g]=new(e?Uint16Array:Uint32Array)(a);for(let l=0;l<a;l++){let d=m[g][l],b=i[g-o][l-1]??1/0,v=i[g-o][l+1]??1/0,w=r?1/0:i[g-o][l],f=Math.min(b,v,w);i[g][l]=d+f>>y}}return i}c(t){if(t.length!==0){for(let e=0;e<this.#n;e++){let r=t.map(n=>n[e]).sort((n,a)=>n-a);this.#e[e]=x(this.#e[e],r)}this.#r-=t.length}}get ut(){return this.#e}};var F=class{timing;values;head;s;Y;time;constructor(t,e=1e3,r=Uint16Array){this.Y=t,this.timing=new Uint16Array(e),this.values=new r(e),this.s=0,this.head=0,this.time=0}w(t){for(this.time++;this.timing[this.s]<=this.time-this.Y&&this.head>this.s;)this.s++;for(;this.values[this.head-1]<=t&&this.head>this.s;)this.head--;return this.head>=this.timing.length&&(this.timing.set(this.timing.subarray(this.s,this.head),0),this.values.set(this.values.subarray(this.s,this.head),0),this.head=this.head-this.s,this.s=0),this.values[this.head]=t,this.timing[this.head]=this.time,this.head++,this.values[this.s]}};var ct={f:.1,G:10},q=class extends R{options;constructor(t){super(t),this.options={...ct,...t}}ht(t){this.options.f=t}async V(){let t=await this.S,e=t.p,r=t.width,n=t.height,s=new L({r:t,q:!0}).ut,i=[],p=t.r;for(let m=0;m<r;m++){let g=p[0][m];i.push({m:new Uint16Array(n),n:g,A:new F(1)}),i[m].m[0]=m}let c=i;for(let m=1;m<n;m++){let g=[];for(let l=0;l<r;l++){let d=c[l];if(l===r-1){d.m[m]=l,d.n+=d.A.w(p[m][l]),g[l]=d;continue}let b=c[l+1],v=d.n<b.n,w=s[m][l]<s[m][l+1];v===w?(d.m[m]=l,d.n+=d.A.w(p[m][l]),g[l]=d):(d.m[m]=l+1,d.n+=d.A.w(p[m][l+1]),g[l+1]=d,b.m[m]=l,b.n+=b.A.w(p[m][l]),g[l]=b,l++)}c=g}i.sort((m,g)=>m.n-g.n);let o=Math.max(Math.ceil(r*this.options.f)>>1<<1,Math.min(this.options.G,r)),h=i.slice(0,o),y=this.y;for(let m=0;m<h.length;m++)h[m].m.forEach((l,d)=>{let b=e[d][l];if(this.l[b]!==65535)throw new Error("Seam overlap detected");this.l[b]=y}),y++;t.c(h.map(m=>m.m)),this.y+=h.length}};Q("predictive",q);var tt=new Map;function Q(u,t){Promise.resolve().then(()=>{tt.set(u,t)})}function et(u){let t=u.generator??"random",e=tt.get(t);if(!e)throw new Error(`[${E}] Generator '${t}' is not registered or included in the build.`);return new e(u)}var _=class{#t;#e=new Map;#r=[];constructor(t){this.#t=t}start(t,e=0){this.#e.set(t,{startTime:performance.now(),dt:e,X:0}),this.#r.push(t)}end(t){let{startTime:e,dt:r,X:n}=this.#e.get(t),a=performance.now()-e;if(a<r)return;let s=this.#r.length;if(s>1){let i=this.#r[s-2],p=this.#e.get(i);p.X+=a}n>0?this.#t(`${t}: ${(a-n).toFixed(2)}ms (${a.toFixed(2)}ms)`):this.#t(`${t}: ${(a-n).toFixed(2)}ms`),this.#r.pop(),this.#e.delete(t)}};function Y(u){return function(...e){if(!this.T)try{let r=u.apply(this,e);return r&&typeof r.catch=="function"?r.catch(n=>{this.C(n)}):r}catch(r){this.C(r)}}}function I(u){return u.replace(/([A-Z])/g,"-$1").toLowerCase()}var rt=u=>({yt:(n,a,s=0,i=1)=>{let p=String(n),c=Number(u[I(p)]??a);if(c<s||c>i)throw new Error(`[${E}] \`${p}\` must be between ${s} and ${i}.`);return c},ft:(n,a)=>{let s=String(n),i=u[I(s)];return i===null?!1:i!==void 0?!0:a},bt:(n,a,s)=>{let i=String(n),p=u[I(i)];return p==null?s:Object.values(a).includes(p)?p:(console.warn(`[${E}] Invalid value for ${i}: "${p}". Defaulting to "${s}".`),s)}});var P={K:"horizontal",Mt:"vertical",Ft:"auto",_t:"dual"};var z=class{canvas;Z;height=0;width=0;options;U;k;I;D;B=!1;i;T=!1;parentNode;src;mask;b=null;O=Y(this.vt).bind(this);Et=Y(this.xt).bind(this);constructor(t){let{parentNode:e,src:r,mask:n,...a}=t;this.parentNode=e,this.src=r,this.mask=n;try{this.options=this.J(a),this.i=new _(this.options.N),this.wt(e)}catch(s){this.C(s)}}destroy(){this.canvas.remove()}get Q(){if(!this.U){let t=new A(this.src,{rotate:!1,i:this.i}),e=this.mask?new A(this.mask,{rotate:!1}):void 0;this.U=this.tt({a:t,h:e})}return this.U}get At(){if(!this.k){let t=new A(this.src,{rotate:!0,i:this.i}),e=this.mask?new A(this.mask,{rotate:!0}):void 0;this.k=this.tt({a:t,h:e})}return this.k}It(){return this.D?this.At:this.Q}tt(t){let e={...this.options,a:t.a,h:t.h};return et(e)}J(t){let{ft:e,yt:r,bt:n}=rt(t);return{...t,carvingPriority:r("carvingPriority",1),maxCarveUpSeamPercentage:r("maxCarveUpSeamPercentage",.6),maxCarveUpScale:r("maxCarveUpScale",10,1,10),maxCarveDownScale:r("maxCarveDownScale",1),scalingAxis:n("scalingAxis",P,P.K),N:t.N??(()=>{}),showEnergyMap:e("showEnergyMap",!1),zt:e("demoMode",!1)}}$(t){let{width:e,height:r}=this.options;if(e===void 0||r===void 0){let n=t.getBoundingClientRect();e=e??n.width,r=r??n.height}return{width:e,height:r}}wt(t){let{width:e,height:r}=this.$(t);this.canvas=document.createElement("canvas"),this.Z=this.canvas.getContext("2d"),this.canvas.width=this.width=e,this.canvas.height=this.height=r,this.canvas.style.display="block",t.appendChild(this.canvas),this.M()}Dt(t,e){this.width=t,this.height=e,this.M()}Wt(t){this.width=t,this.M()}Ht(t){this.height=t,this.M()}vt(t){let e=this.options.showEnergyMap;this.options=this.J({...this.options,...t}),this.options.showEnergyMap!==e&&(this.b=null),this.M()}M(){this.B||(this.B=!0,Promise.resolve().then(async()=>{await this.Et(),this.B=!1}))}Ot(t){let{carvingPriority:e,maxCarveUpSeamPercentage:r,maxCarveUpScale:n,maxCarveDownScale:a}=this.options,{width:s,height:i}=t,{D:p,width:c,height:o}=this,m=(p?o:c)/(p?c:o),g=Math.round(i*m),l=Math.round(s*(1-e)+g*e),d=s-l;if(d===0)return{L:0,F:0,_:!1};let b=Math.abs(d),v=d>0,f=s*(v?a:r),S=v?1:-1,M=Math.floor(Math.min(b,f))*S;if(v)return{L:M,F:0,_:v};let G=Math.floor(s*n)-s,H=Math.max(0,Math.min(b,G));return{L:-M,F:H,_:v}}async Rt(){if(this.options.scalingAxis===P.K)return!1;if(this.options.scalingAxis===P.Mt)return!0;let{width:t,height:e}=await this.Q.at(),r=t/e;return this.width/this.height>r}async Pt(){this.D=await this.Rt(),this.I=this.It()}async St(){if(this.b)return this.b;let t=await this.I.getImageData(),e=new $({t});return this.b=e.g(),this.b}async Gt(){return this.options.showEnergyMap?await this.St():await this.I.getImageData()}async xt(){if(!this.width||!this.height)return;this.i.start("redraw"),await this.Pt();let t=await this.Gt(),{L:e,F:r,_:n}=this.Ot(t),a;if(e===0)a=t;else{this.i.start("generateSeamGrid",1);let o=await this.I.ot(Math.abs(e));this.i.end("generateSeamGrid"),n?a=this.Tt(t,o,e):a=this.Ct(t,o,e,r)}this.canvas.width=a.width,this.canvas.height=a.height,this.Z.putImageData(a,0,0);let s=this.canvas.style,{D:i,width:p,height:c}=this;s.transformOrigin="0 0",s.transform=i?"rotate(-90deg) translateX(-100%)":"",s.width=`${i?c:p}px`,s.height=`${i?p:c}px`,this.i.end("redraw")}Ct(t,e,r,n){let{width:a,height:s,data:i}=t,p=a+n,c=p*s*4,o=new Uint8ClampedArray(c),h=0,y=i.length/4,m=Math.floor(n/r),g=n%r,l=[],d=[],b=m+1,v=m+2;for(let f=0;f<m;f++)l[f]=(f+1)/b;for(let f=0;f<m+1;f++)d[f]=(f+1)/v;let w=0;for(let f=0;f<y;f++){let S=e[f],M=f*4;if(S<r){let W=g>0&&S*g%r<g,G=W?m+1:m,H=W?d:l;if(w===0){let D=i[M],T=i[M+1],C=i[M+2],U=i[M+3];for(let O=0;O<G;O++)o[h]=D,o[h+1]=T,o[h+2]=C,o[h+3]=U,h+=4}else{let D=(f-1)*4,T=i[D],C=i[D+1],U=i[D+2],O=i[D+3],nt=i[M]-T,it=i[M+1]-C,at=i[M+2]-U,st=i[M+3]-O;for(let V=0;V<G;V++){let k=H[V];o[h]=Math.round(T+nt*k),o[h+1]=Math.round(C+it*k),o[h+2]=Math.round(U+at*k),o[h+3]=Math.round(O+st*k),h+=4}}}o[h]=i[M],o[h+1]=i[M+1],o[h+2]=i[M+2],o[h+3]=i[M+3],h+=4,++w===a&&(w=0)}return h!==c&&console.error(`[${E}] Mismatch during interpolation. Wrote ${h} bytes but expected ${c}.`),new ImageData(o,p,s)}Tt(t,e,r){let{width:n,height:a,data:s}=t,i=n-r,p=i*a*4,c=new Uint8ClampedArray(p),o=s.length/4,h=0;for(let y=0;y<o;y++)if(e[y]>=r){let g=y*4;c[h]=s[g],c[h+1]=s[g+1],c[h+2]=s[g+2],c[h+3]=s[g+3],h+=4}return h!==p&&console.error(`[${E}] Mismatch in pixel buffer size. Expected ${p}, but got ${h}.`),new ImageData(c,i,a)}C(t){if(this.T)return;this.T=!0,console.error(`[${E}] A critical error occurred. Falling back to <img>.`,t),this.canvas?.remove();let e=document.createElement("img");e.src=this.src,e.style.width="100%",e.style.height="100%",e.style.display="block",this.parentNode.appendChild(e)}};var X=class u extends HTMLElement{e=null;R=null;v=null;P=new Set;isIntersecting=!1;E=null;options={};static Ut=new Set(["src","scaling-axis","mask","generator"]);constructor(){super()}static get observedAttributes(){return["src","mask","on-screen-threshold",...["generator","carvingPriority","maxCarveUpSeamPercentage","maxCarveUpScale","maxCarveDownScale","scalingAxis","showEnergyMap","mask"].map(I)]}connectedCallback(){this.kt(),this.et()}disconnectedCallback(){this.e?.destroy(),this.e=null,this.R?.disconnect(),this.R=null,this.v?.disconnect(),this.v=null}attributeChangedCallback(t,e,r){e!==r&&(this.P.size||setTimeout(this.Bt),this.P.add(t))}Bt=()=>{let t=Array.from(this.P);if(this.P.clear(),t.some(r=>u.Ut.has(r))){this.e?.destroy(),this.e=null,this.Nt();return}if(t.includes("on-screen-threshold")&&this.et(),!this.e)return;let e=t.reduce((r,n)=>{if(n!=="src"&&n!=="on-screen-threshold"){let a=this.getAttribute(n);r[n]=a}return r},{});this.e.O(e)};$t=t=>{let e=new CustomEvent("log",{detail:{message:t},bubbles:!0,composed:!0});this.dispatchEvent(e)};Nt(){if(this.e)return;let t=this.Lt();this.e=new z({parentNode:this,N:this.$t,...t})}$(){let t=this.clientWidth??100,e=this.clientHeight??100;return{width:t,height:e}}Lt(){let t={};for(let e of u.observedAttributes){let r=I(e);if(this.hasAttribute(r)){let n=this.getAttribute(r);t[e]={"":!0,true:!0,false:!1}[n+""]??n}}return t}kt(){this.parentElement&&(this.R=new ResizeObserver(()=>{let t=this.$();this.E=t,this.rt()}),this.R.observe(this))}et(){this.v?.disconnect();let t=this.getAttribute("on-screen-threshold")||"50px";this.v=new IntersectionObserver(e=>{for(let r of e)this.isIntersecting=r.isIntersecting,this.isIntersecting&&this.rt()},{rootMargin:`${t} ${t} ${t} ${t}`}),this.v.observe(this)}rt(){!this.isIntersecting||!this.E||(this.e?.Dt(this.E.width,this.E.height),this.E=null)}get maxCarveUpScale(){return this.options["max-carve-up-scale"]}set maxCarveUpScale(t){this.options["max-carve-up-scale"]=t,this.e?.O({maxCarveUpScale:t})}get scalingAxis(){return this.options["scaling-axis"]}set scalingAxis(t){this.options["scaling-axis"]=t,this.e?.O({scalingAxis:t})}get showEnergyMap(){return this.options["show-energy-map"]}set showEnergyMap(t){this.options["show-energy-map"]=t,this.e?.O({showEnergyMap:t})}get onScreenThreshold(){let t=this.getAttribute("on-screen-threshold")||"50px";return parseInt(t.replace("px",""),10)}};customElements.define("fluid-img",X);})();
//# sourceMappingURL=fluid-img-predictive.js.map
